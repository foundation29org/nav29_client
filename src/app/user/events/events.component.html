<div class="container-fluid mt-3">
	<button class="btn btn-dark" [routerLink]="['/home']"><i class="fa fa-arrow-left"></i> {{'events.Back to my data' | translate}}</button>
	<div class="mx-auto" [ngClass]="(step!='1')?'small-width':'max-width'">
	
		<div *ngIf="step=='0'" @fadeSlideInOut>
			<div class="card card-block">
				<div class="card-body">
					<div class="row ">
						<div class="col-md-12">
							<button *ngIf="events.length>0" class="ml-1 float-right btn btn-primary" (click)="openStats()">
								{{'generics.Back' | translate}}
							</button>
							<div class="row">
								<h2 *ngIf="!editing" class="content-header mt-0 mb-2">{{'events.NewEvent' | translate}}</h2>
								<h2 *ngIf="editing" class="content-header mt-0 mb-2">{{'events.UpdateEvent' | translate}}</h2>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<form action="#" class="form form-horizontal" [formGroup]="seizuresForm">
								<div class="form-body">
									<div class="">
										<div class="">
											<div class="form-group">
												<label>{{'generics.Name' | translate }}</label>
												<input type="text" class="col-12 form-control" id="numericos2"
													formControlName="name"
													[ngClass]="{ 'is-invalid': submitted && seizuresForm.get('name').errors }"
													name="numericos2">
												<small class="form-text text-muted danger"
													*ngIf="submitted && seizuresForm.get('name').errors">{{'generics.required' |
													translate }}</small>
											</div>
										</div>
										<div class="">
											<div class="form-group">
												<label class="mb-0">{{'generics.Date' | translate }}</label>
												<div class="">
													<mat-form-field class="mr-sm-24" fxFlex>
														<input matInput class="grey" readonly [matDatepicker]="picker"
															autocomplete="off" name="date" formControlName="date">
															<button *ngIf="seizuresForm.value.date!=null" matSuffix mat-icon-button aria-label="Clear" (click)="seizuresForm.controls['date'].setValue(null)" style="position: absolute; left: 30px;">
																<em class="fa fa-trash danger"></em>
															</button>
														<mat-datepicker-toggle matSuffix
															[for]="picker"></mat-datepicker-toggle>
														<mat-datepicker touchUi="true" [startAt]="date" #picker></mat-datepicker>
													</mat-form-field>
	
													<!--<mat-form-field class="mr-sm-24" fxFlex>
														<input matInput class="grey" readonly [matDatepicker]="picker"
															autocomplete="off" name="date" formControlName="date" [max]="viewDate">
														<mat-datepicker-toggle matSuffix
															[for]="picker"></mat-datepicker-toggle>
														<mat-datepicker touchUi="true" [startAt]="date" #picker></mat-datepicker>
													</mat-form-field>-->
												</div>
											</div>
										</div>
										<div class="">
											<div class="form-group">
												<label class="mb-0">{{'events.End Date' | translate }} <small class="text-muted">({{'generics.Optional' | translate}})</small></label>
												<div class="">
													<mat-form-field class="mr-sm-24" fxFlex>
														<input matInput class="grey" readonly [matDatepicker]="pickerEnd"
															autocomplete="off" name="dateEnd" formControlName="dateEnd" [min]="seizuresForm.value.date">
															<button *ngIf="seizuresForm.value.dateEnd!=null" matSuffix mat-icon-button aria-label="Clear" (click)="seizuresForm.controls['dateEnd'].setValue(null)" style="position: absolute; left: 30px;">
																<em class="fa fa-trash danger"></em>
															</button>
														<mat-datepicker-toggle matSuffix
															[for]="pickerEnd"></mat-datepicker-toggle>
														<mat-datepicker touchUi="true" [startAt]="date" #pickerEnd></mat-datepicker>
													</mat-form-field>
												</div>
											</div>
										</div>
										<div>
											<div class="form-group">
												<label for="key">{{ 'events.Type' | translate }}</label>
												<select class="form-control" id="key" formControlName="key">
													<option value="">{{ 'timeline.Select type' | translate }}</option>
												  <option value="diagnosis">ğŸ©º {{ 'timeline.Diagnoses' | translate }}</option>
												  <option value="treatment">ğŸ’‰ {{ 'timeline.Treatment' | translate }}</option>
												  <option value="test">ğŸ”¬ {{ 'timeline.Tests' | translate }}</option>
												  <option value="appointment">ğŸ“… {{ 'events.appointment' | translate }}</option>
												  <option value="symptom">ğŸ¤’ {{ 'timeline.Symptoms' | translate }}</option>
												  <option value="medication">ğŸ’Š {{ 'timeline.Medications' | translate }}</option>
												  <option value="other">ğŸ” {{ 'timeline.Other' | translate }}</option>
												</select>
											  </div>
										</div>
										<div class="">
											<div class="form-group">
												<label>{{'generics.notes' | translate }}</label>
												<textarea maxlength="150" name="notes" formControlName="notes"
													placeholder="{{'generics.Write down any details' | translate }}"
													class="autoajustable form-control"></textarea>
											</div>
										</div>
									</div>
	
								</div>
							</form>
						</div>
						<div class="col-md-12 center-elements">
							<button *ngIf="editing" type="button" class="btn btn-primary mr-1" (click)="deleteSeizure(seizuresForm.value);">{{'generics.Delete' |
								translate }}</button> 
							<button *ngIf="!editing" type="button" class="btn btn-dark" (click)="saveData();">{{'generics.SaveAndClose' |
								translate }}</button>
							<button *ngIf="editing" type="button" class="btn btn-dark ml-1" (click)="updateData();">{{'generics.SaveAndClose' |
								translate }}</button>
						</div>
					</div>
				</div>
			</div>
	
		</div>
		<div *ngIf="step=='1'" @fadeSlideInOut>
			<div class="events-container">
				<!-- Header Section -->
				<div class="events-header">
					<div class="header-content">
						<h1 class="events-title">{{'events.title' | translate }}</h1>
						<button class="btn-new-event" (click)="goto('0');">
							<i class="fa fa-plus"></i>
							<span>{{'generics.New' | translate }}</span>
						</button>
					</div>
				</div>

				<!-- Filters and Actions Bar -->
				<div class="filters-bar" *ngIf="loadedEvents">
					<div class="filters-left">
						<div class="search-container">
							<i class="fa fa-search search-icon"></i>
							<input 
								type="text" 
								class="search-input" 
								(keyup)="applyFilter($event)" 
								[placeholder]="'events.Filter' | translate"
								#input>
						</div>
						
						<div class="sort-container">
							<label class="sort-label">{{'events.Sort by' | translate}}:</label>
							<select class="sort-select" [value]="sortField" (change)="onSortFieldChange($event)">
								<option value="date">{{'generics.Date' | translate}}</option>
								<option value="name">{{'generics.Name' | translate}}</option>
								<option value="origin">{{'events.Origin' | translate}}</option>
							</select>
							<button class="btn-sort-direction" (click)="toggleSortDirection()" [title]="sortDirection === 'asc' ? ('events.Sort descending' | translate) : ('events.Sort ascending' | translate)">
								<i class="fa" [class.fa-sort-amount-up]="sortDirection === 'asc'" [class.fa-sort-amount-down]="sortDirection === 'desc'"></i>
							</button>
						</div>
						
						<div class="date-filter-container">
							<button 
								*ngIf="range.value.start==null && range.value.end==null" 
								class="btn-date-filter" 
								(click)="showDates(contentDates);">
								<i class="fa fa-calendar"></i>
								<span>{{'events.SelectDates' | translate}}</span>
							</button>
							<div *ngIf="range.value.start!=null || range.value.end!=null" class="date-range-display">
								<span class="date-range-text">
									{{range.value.start | date:'shortDate'}} - {{range.value.end | date:'shortDate'}}
								</span>
								<button class="btn-clear-date" (click)="clear();" [title]="'generics.Cancel' | translate">
									<i class="fa fa-times"></i>
								</button>
							</div>
						</div>
					</div>

					<div class="filters-right" *ngIf="selection.selected.length>0 && loadedEvents && events.length>0">
						<div class="selection-info">
							<span class="selection-count">{{selection.selected.length}} {{'generics.selected' | translate}}</span>
						</div>
						<button 
							*ngIf="!deleting" 
							class="btn-delete-selected" 
							(click)="deleteSelected()">
							<i class="fa fa-trash"></i>
							<span>{{'generics.Delete selected' | translate}}</span>
						</button>
						<div *ngIf="deleting" class="deleting-spinner">
							<i class="fa fa-spinner fa-spin"></i>
						</div>
					</div>
				</div>

				<!-- Events List -->
				<div class="events-content" *ngIf="loadedEvents && events.length>0">
					<div class="events-list">
						<div 
							*ngFor="let event of dataSource.filteredData" 
							class="event-card"
							[class.selected]="selection.isSelected(event)"
							[class.expanded]="expandedElement === event">
							<div class="event-card-content">
								<div class="event-checkbox">
									<mat-checkbox 
										(click)="$event.stopPropagation()" 
										(change)="$event ? selection.toggle(event) : null" 
										[checked]="selection.isSelected(event)">
									</mat-checkbox>
								</div>
								
								<div class="event-main">
									<div class="event-header-row">
										<div class="event-title-section">
											<span class="event-icon" *ngIf="event._eventIcon">{{event._eventIcon}}</span>
											<h3 class="event-title">{{event.name}}</h3>
										</div>
										<div class="event-actions">
											<button 
												class="btn-action btn-edit" 
												(click)="showForm(event); $event.stopPropagation();" 
												[title]="'generics.Edit' | translate">
												<i class="fa fa-pencil"></i>
											</button>
											<button 
												class="btn-action btn-delete" 
												(click)="deleteSeizure(event); $event.stopPropagation();" 
												[title]="'generics.Delete' | translate">
												<i class="fa fa-trash"></i>
											</button>
										</div>
									</div>
									
									<div class="event-meta">
										<div class="event-meta-item">
											<i class="fa fa-tag meta-icon"></i>
											<span class="meta-label">{{'events.Origin' | translate}}:</span>
											<span class="meta-value" *ngIf="!event.docId">{{event._originText}}</span>
											<span class="meta-value" *ngIf="event.docId">
												<i class="fa fa-file-text-o"></i> {{event.documentTitle}}
											</span>
										</div>
										<div class="event-meta-item">
											<i class="fa fa-calendar meta-icon"></i>
											<span class="meta-label">{{'generics.Date' | translate}}:</span>
											<span class="meta-value">
												<span *ngIf="!event.dateEnd">
													{{event.date ? (event.date | date:'mediumDate') : '--/--/--'}}
												</span>
												<span *ngIf="event.dateEnd">
													{{event.date ? (event.date | date:'mediumDate') : '--/--/--'}} - {{event.dateEnd | date:'mediumDate'}}
												</span>
											</span>
										</div>
									</div>

									<div 
										class="event-notes-expand" 
										*ngIf="event.notes && event.notes !== ''"
										[@detailExpand]="expandedElement === event ? 'expanded' : 'collapsed'">
										<div class="event-notes">
											<strong>{{'generics.notes' | translate}}:</strong>
											<p>{{event.notes}}</p>
										</div>
									</div>

									<button 
										*ngIf="event.notes && event.notes !== ''" 
										class="btn-expand-notes"
										(click)="expandedElement = expandedElement === event ? null : event; $event.stopPropagation();">
										<i class="fa" [class.fa-chevron-down]="expandedElement !== event" [class.fa-chevron-up]="expandedElement === event"></i>
										<span>{{expandedElement === event ? ('generics.Hide' | translate) : ('generics.Show notes' | translate)}}</span>
									</button>
								</div>
							</div>
						</div>
					</div>

					<!-- No Results Message -->
					<div class="no-results" *ngIf="dataSource.filteredData.length === 0 && input.value">
						<i class="fa fa-search"></i>
						<p>{{'events.NoMaching' | translate}} "{{input.value}}"</p>
					</div>
				</div>

				<!-- Empty State -->
				<div class="empty-state" *ngIf="loadedEvents && events.length==0">
					<div class="empty-state-content">
						<i class="fa fa-calendar-check-o empty-icon"></i>
						<h3>{{'generics.No data' | translate }}</h3>
						<p>{{'events.No events yet' | translate}}</p>
						<button class="btn-new-event-empty" (click)="goto('0');">
							<i class="fa fa-plus"></i>
							<span>{{'events.Create first event' | translate}}</span>
						</button>
					</div>
				</div>

				<!-- Loading State -->
				<div class="loading-state" *ngIf="!loadedEvents">
					<div class="loading-content">
						<i class="fa fa-spinner fa-spin loading-spinner"></i>
						<p>{{'generics.Loading' | translate}}...</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<ng-template #contentDates let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header" id="idHeader">
        {{'events.SelectDates' | translate}}
        <button type="button" class="close" aria-label="Close" (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body content-wrapper p-2" id="idBody">
        <div class="row col-md-12 mt-2">
			<mat-form-field appearance="fill">
				<mat-label>{{'events.RangeDate' | translate}}</mat-label>
				<mat-date-range-input [formGroup]="range" [rangePicker]="picker">
					<input matStartDate formControlName="start" placeholder="{{'events.Start Date' | translate }}">
					<input matEndDate formControlName="end" placeholder="{{'events.End Date' | translate }}">
				</mat-date-range-input>
				<mat-hint>MM/DD/YYYY â€“ MM/DD/YYYY</mat-hint>
				<mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
				<mat-date-range-picker #picker></mat-date-range-picker>

				<mat-error *ngIf="range.controls.start.hasError('matStartDateInvalid')">{{'events.InvalidStart' | translate}}</mat-error>
				<mat-error *ngIf="range.controls.end.hasError('matEndDateInvalid')">{{'events.InvalidEnd' | translate}}</mat-error>
			</mat-form-field>
		</div>
		

		<p class="mt-2">{{'events.SelectedRange' | translate}}: {{range.value.start | date}} - {{range.value.end | date}}</p>

    </div>
	<div class="modal-footer">
		<button type="button" class="btn btn-secondary" (click)="clear();">{{'generics.Cancel' | translate}}</button>
		<button type="button" class="btn btn-dark" (click)="applyRangeDates();">{{'events.Apply' | translate}}</button>
	</div>
</ng-template>