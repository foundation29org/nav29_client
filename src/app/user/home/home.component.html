<div *ngIf="!loadedDocs">
    <div class="pt-4 mx-auto center-elements" style="max-width: 40rem !important;">
        <em class="fa fa-spinner fa-spin fa-3x fa-fw primary"></em>
    </div>
</div>
<ng-container *ngIf="loadedDocs">
    <!-- Menú de navegación solo para pantallas pequeñas -->
    <div *ngIf="isSmallScreen()"
    class="navigation-menu border-bottom d-flex justify-content-center align-items-center py-2 w-100">
    <div class="btn-group w-100 px-2" role="group">
        <!-- view documents-->
        <button class="btn btn-dark flex-grow-1"
            [ngClass]="{'active-view': currentView === 'documents'}"
            (click)="setView('documents')" title="{{'topnavbar.Reports' | translate}}">
            <i class="fa fa-file-text"></i>
            <span class="ml-2" *ngIf="!isXSScreen()">{{'topnavbar.Reports' | translate }}</span>
        </button>
        <button class="btn btn-dark flex-grow-1"
            [ngClass]="{'active-view': currentView === 'chat' && !(isSmallScreen() && rightSidebarOpenMobile)}"
            (click)="setView('chat')" title="{{'home.s1.2' | translate}}">
            <i class="fa-kit fa-ai"></i>
            <span class="ml-2" *ngIf="!isXSScreen()">{{'home.s1.2' | translate}}</span>
        </button>
        <button class="btn btn-dark flex-grow-1" id="diary-title"
            [ngClass]="{'active-view': currentView === 'diary' || (isSmallScreen() && rightSidebarOpenMobile)}"
            (click)="isSmallScreen() ? openRightSidebarMobile() : setView('diary')" 
            title="{{'tools.title' | translate}}">
            <i class="fa fa-briefcase"></i>
            <span class="ml-2" *ngIf="!isXSScreen()">{{'tools.title' | translate}}</span>
        </button>
    </div>
</div>
    <div class="main-container-user pb-4" [ngClass]="{'right-sidebar-open': !isSmallScreen() && currentView === 'chat' && !rightSidebarCollapsed, 'right-sidebar-collapsed': !isSmallScreen() && currentView === 'chat' && rightSidebarCollapsed, 'right-sidebar-mobile-open': isSmallScreen() && rightSidebarOpenMobile}">
        <div *ngIf="isSmallScreen() && currentView === 'chat' && messages.length > 0"
            class="fixed-buttons-container p-0 pt-1 pb-1 border-bottom d-flex justify-content-between align-items-center"
            style="background-color: #f0f0f0;">
            <div class="flex-grow-1 d-flex justify-content-center align-items-center gap-2">
                <div class="mr-2" style="z-index: 0;">
                    <button class="btn btn-white" (click)="deleteChat()"
                        [attr.title]="isStepInProcess() ? ('generics.Please wait' | translate) : ('home.s1.2.1' | translate)"
                        [disabled]="isStepInProcess()">
                        <em class="fa fa-plus mr-1"></em> {{'home.s1.2.1' | translate }}
                    </button>
                </div>
                <button class="btn btn-primary btn-sm" 
                        *ngIf="scrollToBottomVisible && currentView === 'chat' && messages.length > 0"
                        (click)="scrollToBottomPage(); trackEventsService.lauchEvent('scroll btn 2')"
                        title="Ir al final">
                    <i class="fa fa-arrow-down"></i>
                </button>
            </div>
        </div>
        <div *ngIf="!isSmallScreen()"
            class="fixed-buttons-container d-flex justify-content-between align-items-center" 
            [ngClass]="{'left300': currentView === 'chat', 'left-sidebar-collapsed': leftSidebarCollapsed && currentView === 'chat'}">


            <!-- New Chat Button y Scroll to Bottom - Solo visible en la vista de chat cuando hay mensajes -->
            <div *ngIf="currentView === 'chat' && messages.length > 0" class="position-absolute d-flex align-items-center" style="right: 1rem; top: 0.5rem; gap: 0.5rem;">
                <button class="btn btn-primary btn-sm" 
                        *ngIf="scrollToBottomVisible"
                        (click)="scrollToBottomPage(); trackEventsService.lauchEvent('scroll btn 2')"
                        title="Ir al final">
                    <i class="fa fa-arrow-down"></i>
                </button>
                <button class="btn btn-white btn-sm" (click)="deleteChat()"
                    [attr.title]="isStepInProcess() ? ('generics.Please wait' | translate) : ('home.s1.2.1' | translate)"
                    [disabled]="isStepInProcess()">
                    <em class="fa fa-plus mr-1"></em> {{'home.s1.2.1' | translate }}
                </button>
            </div>
        </div>

        <div *ngIf="currentView != 'diary' && currentView != 'notes' && currentView != 'dxgpt' && currentView != 'rarescope'" class="sidebar border-right"
            [ngClass]="{'open': sidebarOpen || !isSmallScreen(), 'collapsed': leftSidebarCollapsed && !isSmallScreen()}">
            <div class="sidebar-content" id="sidebar-content">
                <!-- Título vertical cuando está plegado -->
                <div class="sidebar-title-vertical" *ngIf="leftSidebarCollapsed && !isSmallScreen()">
                    <span>{{'home.s1.3' | translate}}</span>
                </div>
                <!-- Header -->
                <div class="sidebar-header">
                    <div class="sidebar-header-top">
                        <h2 class="sidebar-main-title">{{'home.s1.3' | translate}}</h2>
                        <button class="sidebar-toggle-btn" 
                                *ngIf="!isSmallScreen()"
                                (click)="toggleLeftSidebar()" 
                                [title]="leftSidebarCollapsed ? 'Expandir' : 'Plegar'">
                            <i class="fa" [ngClass]="leftSidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                        </button>
                    </div>
                    <div class="sidebar-section-header" *ngIf="!leftSidebarCollapsed">
                        <h5 class="section-title">{{'topnavbar.Reports' | translate }}</h5>
                        <button type="button" class="btn botonAddDoc btn-dark"
                            (click)="openOptionsFiles(contentviewSelectFile)" title="{{'generics.Add' | translate }}">
                            <i class="white fa fa-plus"></i>
                        </button>
                    </div>
                    <!--<button class="sidebar-close" (click)="toggleSidebar()" *ngIf="isSmallScreen()"
                        title="{{'generics.Close' | translate }}">
                        <i class="fa fa-times"></i>
                    </button>-->
                </div>

                <!-- Main Content -->
                <div class="sidebar-main" *ngIf="!leftSidebarCollapsed || isSmallScreen()">
                    <div *ngIf="docs.length > 0" class="pb-3">
                        <div *ngIf="docs.length > 7" class="mb-3">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control mt-0 filter-input" [(ngModel)]="searchTerm"
                                    (input)="searchDocs()" placeholder="{{'reportsSection.Filter' | translate }}">
                            </div>
                            <small class="d-block mb-1"><strong>{{'generics.Sort' | translate }}:</strong></small>
                            <div class="d-flex justify-content-between align-items-center">

                                <div>
                                    <button class="btn btn-sm btn-light bg-grey bg-lighten-4 mr-1"
                                        (click)="sortDocs('title')" [ngClass]="{'active': sortKey == 'title'}">
                                        {{'generics.Name' | translate }}
                                        <i *ngIf="sortKey == 'title'"
                                            [ngClass]="(sortDirection == '1') ? 'fa fa-arrow-up' : 'fa fa-arrow-down'"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light bg-grey bg-lighten-4 mr-1"
                                        (click)="sortDocs('categoryTag')"
                                        [ngClass]="{'active': sortKey == 'categoryTag'}">
                                        {{'reportsSection.Type' | translate }}
                                        <i *ngIf="sortKey == 'categoryTag'"
                                            [ngClass]="(sortDirection == '-1') ? 'fa fa-arrow-up' : 'fa fa-arrow-down'"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light bg-grey bg-lighten-4"
                                        (click)="sortDocs('originaldate')"
                                        [ngClass]="{'active': sortKey == 'originaldate'}">
                                        {{'generics.Date' | translate }}
                                        <i *ngIf="sortKey == 'originaldate'"
                                            [ngClass]="(sortDirection == '-1') ? 'fa fa-arrow-up' : 'fa fa-arrow-down'"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 text-center" *ngIf="getAvailableDocumentsCount() > 0">
                            <button type="button" class="btn btn-sm btn-white btn-block" (click)="openDocumentContextModal()">
                                <em class="fa fa-cog mr-1"></em>
                                {{'generics.Manage documents' | translate }}
                            </button>
                        </div>
                        <ul class="document-list">
                            <li *ngFor="let doc of filteredDocs">
                                <div class="document-item-content" 
                                    [ngClass]="{'document-not-selected': (doc.status == 'finished' || doc.status == 'done' || doc.status == 'resumen ready') && !doc.selected}">
                                    <span class="document-status-icon"
                                        *ngIf="doc.status != 'finished' && doc.status != 'done' && doc.status != 'resumen ready'">
                                        <em *ngIf="doc.status == 'pending' || doc.status == ''" class="fa fa-clock-o"></em>
                                        <em *ngIf="doc.status == 'inProcess' || doc.status == 'creando resumen' || doc.status == 'extracted_translated done' || doc.status == 'extracted done'"
                                            class="fa fa-spinner primary fa-spin"></em>
                                        <em *ngIf="doc.status == 'finished' || doc.status == 'done' || doc.status == 'resumen ready'"
                                            class="success fa fa-check"></em>
                                        <em *ngIf="doc.status == 'failed'" class="danger fa-solid fa-file-exclamation"
                                            title="{{'generics.A file has failed and needs to be deleted' | translate }}"></em>
                                    </span>
                                    <div class="document-info">
                                        <div class="document-header">
                                            <ng-container
                                                *ngIf="doc.status == 'finished' || doc.status == 'done' || doc.status == 'resumen ready'; else regularTitle">
                                                <span class="document-file-icon" [style.color]="getFileIconColor(doc.title)" *ngIf="doc.status == 'finished' || doc.status == 'done' || doc.status == 'resumen ready'">
                                                    <em [class]="'fa ' + getFileIconClass(doc.title)"></em>
                                                </span>
                                                <a href="javascript:void(0)" class="document-link"
                                                    (click)="openResults(doc, contentSummaryDoc)" [disabled]="openingResults"
                                                    [title]="doc.title">
                                                    {{truncateTitle(doc.title)}}
                                                </a>
                                            </ng-container>
                                            <ng-template #regularTitle>
                                                <span class="document-file-icon" [style.color]="getFileIconColor(doc.title)">
                                                    <em [class]="'fa ' + getFileIconClass(doc.title)"></em>
                                                </span>
                                                <span class="document-title" [title]="doc.title">{{truncateTitle(doc.title)}}</span>
                                            </ng-template>
                                            <span *ngIf="doc.status == 'failed' && doc.isOwner" class="document-delete">
                                                <span [disabled]="openingResults" (click)="deleteDoc(doc)" class="pointer"
                                                    href="javascript:void(0)" title="{{'generics.Delete' | translate }}">
                                                    <em class="fa fa-trash primary"></em>
                                                </span>
                                            </span>
                                        </div>
                                        <div class="document-meta">
                                            <span class="document-date"
                                                *ngIf="!isDateMissing(doc.originaldate); else missingDate">
                                                {{ doc.originaldate | date: 'mediumDate' }}
                                            </span>
                                            <ng-template #missingDate>
                                                <span class="text-warning pointer d-flex align-items-center document-missing-date"
                                                    (click)="openUpdateDocDate(doc, PanelChangeDate)"
                                                    title="{{ 'dashboardpatient.Update document date' | translate }}">
                                                    <em class="fa fa-exclamation-triangle mr-1"></em>
                                                    <span>{{ 'generics.Missing date' | translate }}</span>
                                                    <em class="fa fa-edit ml-1"></em>
                                                </span>
                                            </ng-template>
                                            <span class="document-badge" *ngIf="doc.categoryTag">
                                                <span [ngClass]="doc.badge" class="badge">
                                                    {{doc.categoryTag}}
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Footer -->
                <div class="sidebar-footer" *ngIf="!leftSidebarCollapsed || isSmallScreen()">
                    <div class="d-flex justify-content-between align-items-center mb-3" *ngIf="loadedAllEvents">
                        <div class="btn-sm">
                            <span class="font-weight-bold">{{allEvents.length}}</span> {{'events.title' | translate }}
                        </div>
                        <button routerLink="/events" class="btn btn-sm btn-white">
                            {{'generics.View' | translate }}
                        </button>
                    </div>

                    <button class="btn btn-white btn-block btn-sm" (click)="openTimelineModal(timelineModal)"
                        *ngIf="timeline.length > 0">
                        <span>{{'timeline.Timeline' | translate }}</span>
                        <span class="ml-1 badge badge-dark">{{timeline.length}}</span>
                        <span *ngIf="eventsNeedingReviewCount > 0" class="ml-1 badge badge-danger" title="{{'timeline.Events needing review' | translate}}">
                            <i class="fa fa-exclamation-triangle"></i>
                        </span>
                    </button>
                </div>
            </div>
        </div>
        <div class="content mleft300" *ngIf="currentView === 'chat'" [ngClass]="{'left-sidebar-collapsed': leftSidebarCollapsed && !isSmallScreen()}">
            <ng-container>
                <div class="mx-auto" style="max-width: 60rem !important;">
                    <ng-container *ngIf="messages.length < 1" class="main-chat-container">
                        <div class="row center-elements">
                            <div class="col-md-12">
                                <img class="logo-img-big" style="width: 160px;" src='assets/img/logo-lg-white.png' />
                            </div>
                            <div class="col-md-12 mb-2 mt-3">
                                <p>{{'optionsMenu.t1' | translate }}
                                    <a class="d-none text-decoration center-elements"
                                        (click)="startTutorial()"><ins>Tutorial</ins></a>
                                </p>
                                <p>{{'optionsMenu.t2' | translate }} <em class="primary" style="cursor: pointer;"
                                        placement="end-start" #p1="ngbPopover" [ngbPopover]="popContenthelp"
                                        popoverTitle="{{'topnavbar.Help' | translate }}">{{'optionsMenu.t3' | translate
                                        }}</em> {{'optionsMenu.t4' | translate }}</p>
                                <ng-template #popContenthelp>
                                    <span [innerHTML]="welcomeMsg | safe: 'html'">
                                    </span>
                                    <button class="pull-right mt-2" style="margin-top: 1em;margin-bottom: 1em;"
                                        (click)="p1.close()">{{'generics.Close' | translate }}</button>
                                </ng-template>
                            </div>
                            <div class="col-md-12 mb-2 mt-2 d-block" *ngIf="actualCategory == null">
                                <div class="border bg-grey bg-lighten-3 p-3">
                                    <a class="mr-1"
                                        [ngClass]="(showOptionsData == 'general') ? 'text-bold-700 border-custom' : ''"
                                        (click)="changeOptionData('general')">{{'optionsMenu.t5' | translate }}</a>
                                    <a class="ml-1 mr-1"
                                        [ngClass]="(showOptionsData == 'categoriesPatients') ? 'text-bold-700 border-custom' : ''"
                                        (click)="changeOptionData('categoriesPatients')">{{'categoriesPatients.title' |
                                        translate }}</a>
                                    <a class="ml-1 mr-1"
                                        [ngClass]="(showOptionsData == 'categoriesCaregivers') ? 'text-bold-700 border-custom' : ''"
                                        (click)="changeOptionData('categoriesCaregivers')">{{'categoriesCaregivers.title'
                                        | translate }}</a>
                                    <a class="ml-1"
                                        [ngClass]="(showOptionsData == 'summaryTypes') ? 'text-bold-700 border-custom' : ''"
                                        (click)="changeOptionData('summaryTypes')">{{'summaryoptions.title' | translate
                                        }}</a>
                                </div>
                            </div>
                            <ng-container *ngIf="showOptionsData == 'general'">
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                (click)="selectCustomSuggestion('optionsMenu.q1')">
                                                {{'optionsMenu.q1' | translate }}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                (click)="selectCustomSuggestion('optionsMenu.q2')">
                                                {{'optionsMenu.q2' | translate }}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                (click)="selectCustomSuggestion('optionsMenu.q3')">
                                                {{'optionsMenu.q3' | translate }}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                (click)="selectCustomSuggestion('optionsMenu.q4')">
                                                {{'optionsMenu.q4' | translate }}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div
                                                class="card card-body card-custom d-flex justify-content-center align-items-center">

                                                <li class="d-inline" ngbDropdown display="dynamic" placement="bottom">
                                                    <a class="position-relative colorlink" id="dropdownLang"
                                                        ngbDropdownToggle role="button">
                                                        <u>{{'optionsMenu.q5' | translate }}</u>
                                                    </a>
                                                    <div ngbDropdownMenu aria-labelledby="dropdownLang"
                                                        class="dropdownLang">
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.1')">
                                                            <span>{{'optionsMenu.q5.1' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.2')">
                                                            <span>{{'optionsMenu.q5.2' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.3')">
                                                            <span>{{'optionsMenu.q5.3' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.4')">
                                                            <span>{{'optionsMenu.q5.4' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.5')">
                                                            <span>{{'optionsMenu.q5.5' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.6')">
                                                            <span>{{'optionsMenu.q5.6' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.7')">
                                                            <span>{{'optionsMenu.q5.7' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.8')">
                                                            <span>{{'optionsMenu.q5.8' | translate }}</span>
                                                        </a>
                                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                                            (click)="selectCustomSuggestion('optionsMenu.q5.9')">
                                                            <span>{{'optionsMenu.q5.9' | translate }}</span>
                                                        </a>
                                                    </div>
                                                </li>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                (click)="selectCustomSuggestion('optionsMenu.q6')">
                                                {{'optionsMenu.q6' | translate }}
                                            </div>
                                        </div>
                                        <p class="text-muted small mt-2">
                                            <em>{{'optionsMenu.hint' | translate }}</em>
                                        </p>
                                    </div>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="showOptionsData == 'summaryTypes'">
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-6" *ngFor="let summaryType of summaryTypes">
                                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                (click)="selectSummaryType(summaryType.description)">
                                                <h5>{{summaryType.title | translate}}</h5>
                                                <p>{{summaryType.description | translate}}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="showOptionsData != 'general' && showOptionsData != 'summaryTypes'">
                                <div class="col-md-12">
                                    <ng-container *ngIf="actualCategory == null">
                                        <div class="row">
                                            <p class="col-md-12 mb-0 mt-2 black text-bold-700">{{'generics.Select a
                                                category' | translate }}:</p>
                                            <span class="col-md-12" *ngIf="showOptionsData == 'categoriesPatients'">
                                                <div class="row">
                                                    <div *ngFor="let categorie of categoriesPatients" class="col-md-4">
                                                        <div class="card card-body border card-categorie d-flex justify-content-center align-items-center pointer"
                                                            (click)="selectCategorie(categorie)">
                                                            <img class="logo-img-big" style="width: 60px;"
                                                                [src]="categorie.icon" /> <u>{{categorie.title}} </u>
                                                        </div>
                                                    </div>
                                                </div>
                                            </span>
                                            <span class="col-md-12" *ngIf="showOptionsData == 'categoriesCaregivers'">
                                                <div class="row">
                                                    <div *ngFor="let categorie of categoriesCaregivers"
                                                        class="col-md-4">
                                                        <div class="card card-body border card-categorie d-flex justify-content-center align-items-center pointer"
                                                            (click)="selectCategorie(categorie)">
                                                            <img class="logo-img-big" style="width: 60px;"
                                                                [src]="categorie.icon" /> <u>{{categorie.title}} </u>
                                                        </div>
                                                    </div>
                                                </div>
                                            </span>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="actualCategory != null">
                                        <div class="row">
                                            <div class="col-md-12 center-elements">
                                                <!-- Botón para regresar o seleccionar otra categoría -->
                                                <button class="btn btn-dark" (click)="actualCategory = null"><em
                                                        class="fa fa-arrow-up"></em> {{'generics.Back to categories' |
                                                    translate }}</button>
                                                <!-- Icono y nombre de la categoría seleccionada -->
                                                <div class="category-header mt-4">
                                                    <img class="logo-img-small" style="width: 30px; height: 30px;"
                                                        src="{{actualCategory.icon}}" />
                                                    <span class="text-bold-700">{{actualCategory.title}}</span>
                                                </div>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="row">
                                                    <div *ngFor="let suggestion of actualCategory.questions"
                                                        class="col-md-4">
                                                        <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                                            (click)="selectSuggestion(suggestion)">
                                                            {{suggestion}}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                            </ng-container>
                            <p class="mt-2" *ngIf="docs.length == 0" [innerHTML]="'optionsMenu.t7' | translate"></p>
                        </div>
                    </ng-container>
                    <div *ngIf="messages.length > 0" class="main-chat-container">
                        <div class="chat-container">
                            <div *ngFor="let message of messages; let i = index" class="chat-messages"
                                [ngClass]="{'user-is-sender': message.isUser}"
                                [@messageAnimation]>
                                <div class="message-row"
                                    [ngClass]="{'user-message': message.isUser, 'response-message': !message.isUser, 'response-form': !message.isUser}">
                                    <ng-container *ngIf="message.task">
                                        <span [innerHTML]="message.text | safe: 'html'"
                                            (click)="onMessageClick($event, i)"></span>
                                        <span *ngIf="message.task.steps">
                                            <small class="noti-text d-block mb-1 mt-2"
                                                *ngFor="let step of message.task.steps">
                                                <em *ngIf="step.status == 'pending'" class="fa fa-clock-o"></em>
                                                <em *ngIf="step.status == 'inProcess'"
                                                    class="fa fa-spinner primary fa-spin"></em>
                                                <em *ngIf="step.status == 'finished'" class="success fa fa-check"></em>
                                                <em *ngIf="step.status == 'failed'"
                                                    class="danger fa-solid fa-file-exclamation"
                                                    title="{{'generics.A file has failed and needs to be deleted' | translate }}"></em>
                                                <span class="ml-1" *ngIf="step.name">{{step.name}}</span>
                                                <span class="mb-1 d-block" *ngIf="step.data && step.data !== undefined"
                                                    style="margin-left: 1rem !important"><strong>{{step.data}}
                                                        {{'messages.m4.3' | translate }}</strong> </span>
                                                <span
                                                    *ngIf="step.status == 'finished' && step.name != translateYouCanAskInChat && step.action !== undefined"
                                                    class="ml-1" [innerHTML]="step.action | safe: 'html'"
                                                    (click)="onMessageClick($event, i)"></span>
                                            </small>
                                        </span>
                                    </ng-container>
                                    <ng-container *ngIf="message.file">
                                        <span class="d-block">{{'documents.Select document' | translate }}: </span>
                                        <div class="row">
                                            <div class="col-md-4" *ngIf="showCameraButton">
                                                <div><button style="min-height: 45px;" class="btn btn-sm btn-dark mt-2"
                                                        (click)="entryOpt('opt1', contentPhoto)">{{'demo.Take a photo' |
                                                        translate }}</button></div>
                                            </div>
                                            <div [ngClass]="{'col-md-4': showCameraButton, 'col-6': !showCameraButton}">
                                                <input *ngIf="!isMobile" type="file" #fileDropRef id="fileDropRef"
                                                    multiple style="display: none;" (change)="onFileChangeStep($event);"
                                                    accept=".pdf, .docx, .jpg, .png, .jpeg, .txt" />
                                                <input *ngIf="isMobile" type="file" #fileDropRef id="fileDropRef"
                                                    multiple style="display: none;"
                                                    (change)="onFileChangeStep($event);" />
                                                <label style="min-height: 45px;"
                                                    class="mb-1 mt-2 btn btn-dark btn-sm mb-0"
                                                    style="text-transform: none;letter-spacing: 0px;cursor: pointer;"
                                                    for="fileDropRef">{{'generics.Upload' | translate }}
                                                </label>
                                                <span class="text-muted small d-block">{{'demo.Max. 5 documents' |
                                                    translate }}</span>
                                                <span class="text-muted small d-block">{{'demo.You can upload more files later' |
                                                    translate }}</span>
                                            </div>
                                            <div [ngClass]="{'col-md-4': showCameraButton, 'col-6': !showCameraButton}">
                                                <div><button style="min-height: 45px;" class="btn btn-sm btn-dark mt-2"
                                                        (click)="entryOpt('opt2', contentManual)">{{'demo.Write text' |
                                                        translate }}</button></div>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!message.task && !message.file">
                                        <span [innerHTML]="message.text | safe: 'html'"
                                            (click)="onMessageClick($event, i)"></span>
                                        <span *ngIf="!message.isUser" class="d-block mt-2">
                                            <button class="btn btn-sm btn-white"
                                                (click)="addNoteWithMessage(message.text)" [disabled]="savingNote"
                                                title="{{'notes.Save to notes' | translate }}">
                                                <em class="fa-solid fa-thumbtack mr-1"></em> {{'notes.Save to notes' |
                                                translate }}
                                            </button>
                                            <span *ngIf="!message.isUser">
                                                <span class="float-right">
                                                    <em class="fa fa-clipboard pointer" (click)="copymsg(message)"
                                                        title="{{'generics.Copy' | translate }}"></em>
                                                    <em class="fa fa-thumbs-up ml-2 pointer" *ngIf="i != 0"
                                                        (click)="sendFeedback(true, message.text)"
                                                        title="{{'generics.Like' | translate }}"></em>
                                                    <em class="fa fa-thumbs-down ml-2 pointer" *ngIf="i != 0"
                                                        (click)="sendFeedback(false, message.text)"
                                                        title="{{'generics.Dislike' | translate }}"></em>
                                                </span>
                                            </span>
                                        </span>


                                    </ng-container>
                                </div>
                            </div>
                            <div class="chat-messages pt-2"
                                *ngIf="(callingOpenai || gettingSuggestions) || actualStatus == 'generando sugerencias'">
                                <div style="display: inline-block;">
                                    <div class="loading-dots">
                                        <em class="fa fa-circle"></em>
                                        <em class="fa fa-circle"></em>
                                        <em class="fa fa-circle"></em>
                                    </div>
                                    <span class="typewriter-text" style="color: #6c757d; font-size: 0.95rem;"
                                        [innerHTML]="messagesExpectOutPut">
                                    </span>
                                </div>
                            </div>
                            <span>
                                <span *ngIf="proposedEvents.length > 0" class="mb-2" style="display: flex;">
                                    <span class="border"
                                        style="background-color: white !important;border-radius: 1rem;">
                                        <span *ngIf="proposedEvents.length == 1">
                                            <h6 class="m-2" *ngIf="proposedEvents.length == 1">{{'events.event has been
                                                detected' | translate}}</h6>
                                            <p class="m-2">{{'events.We need you to validate if is correct' |
                                                translate}}</p>
                                        </span>
                                        <span *ngIf="proposedEvents.length > 1">
                                            <h6 class="m-2" *ngIf="proposedEvents.length > 1">{{'events.events have been
                                                detected' | translate: { value: proposedEvents.length } }}</h6>
                                            <p class="m-2">{{'events.Save or delete to continue the conversation' |
                                                translate}}</p>
                                        </span>
                                        <div *ngFor="let proposedEvent of proposedEvents; let j = index" class="m-2">
                                            <hr class="mt-2 mb-2">
                                            <p class=""><strong>{{'generics.Name' | translate}}:</strong><span
                                                    class="ml-1">{{proposedEvent.insight}}</span></p>
                                            <p class=""><strong>{{'generics.Date' | translate}}:</strong><span
                                                    class="ml-1">
                                                    <span *ngIf="!proposedEvent.dateEnd">{{proposedEvent.date | date: timeformat}}</span>
                                                    <span *ngIf="proposedEvent.dateEnd">{{proposedEvent.date | date: timeformat}} - {{proposedEvent.dateEnd | date: timeformat}}</span>
                                                </span></p>
                                            <p class=""><strong>{{'timeline.Event type' | translate }}:</strong>
                                                <span class="ml-1"> {{getEventTypeDisplay(proposedEvent.key)}}

                                                </span>
                                            </p>
                                            <p *ngIf="!proposedEvent.saving && !submitted">
                                                <button class="mb-1 btn btn-white btn-sm mr-1" title=""
                                                    (click)="editProposedEvent(proposedEvent)"><i
                                                        class="fa fa-edit success"></i> {{'generics.Edit' |
                                                    translate}}</button>
                                                <button class="mb-1 btn btn-white btn-sm ml-1 mr-1" title=""
                                                    (click)="addProposedEvent(proposedEvent)"><i
                                                        class="fa fa-plus success"></i> {{'generics.Save' |
                                                    translate}}</button>
                                                <button class="mb-1 btn btn-white btn-sm ml-1" title=""
                                                    (click)="deleteProposedEvent(j)"><i class="fa fa-trash danger"></i>
                                                    {{'generics.Delete' | translate}}</button>
                                            </p>
                                            <p *ngIf="proposedEvent.saving">
                                                <em class="fa fa-spinner fa-spin fa-2x fa-fw primary"></em>
                                            </p>
                                        </div>
                                        <div *ngIf="proposedEvents.length > 1"
                                            class="border-top pt-3 pb-2 center-elements">
                                            <button class="mb-1 btn btn-white btn-sm mr-1" title=""
                                                (click)="addAllProposedEvents()"><i class="fa fa-plus success"></i>
                                                {{'generics.Save all' | translate}}</button>
                                            <button class="mb-1 btn btn-white btn-sm ml-1" title=""
                                                (click)="deleteAllProposedEvents()"><i class="fa fa-trash danger"></i>
                                                {{'generics.Delete all' | translate}}</button>
                                        </div>
                                    </span>
                                </span>
                                <span
                                    *ngIf="suggestions.length > 0 && proposedEvents.length == 0"
                                    class="suggestion-items">
                                    <span *ngFor="let suggestion of suggestions" class="suggestion-item"
                                        title="{{suggestion}}">
                                        <button class="btn btn-sm btn-outline-dark"
                                            (click)="selectSuggestion(suggestion)">{{suggestion}}</button>
                                    </span>
                                    <span class="suggestion-item">
                                        <button class="btn btn-sm btn-outline-dark"
                                            (click)="showOptionsMenu(ContentOptionsMenu)"
                                            title="{{'topnavbar.Help' | translate }}">
                                            <img class="icon-dark" height="18px"
                                                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAABcUlEQVR4nM1VvU7DQAyOYGOAoTC0kx07VTdeggmJkQ0YeYOK92FkomqYeI0KCUREpdidGJHKQFXk0krJkaRHmwKWTqf78+efz74g+G15Zd5VhsckDPc2AjBiPFPGqc0bAVDGngHYXLvyEfOBMo7nAGNbr63UYj0PSy+jfDHGtm/nbk6k02oowbPNlQDCOHSUFg4hfMm9i6A724+gWwmgzeaOMJ4I47UQvuUUE7wrQT8luMh6MA2CLSFMZgCMw2kQbNeagzQMj7OG2NoLIMsiYbwtvwN3jqdxbXWQRnAojJNcfhgntu9dyZZQN+aphYUgdpVnQezc7tl9fwoTXArhgw/TMoxLlOFK2+39WiisZUCMw7/1YCEz3kd4pIw3wvhRkYN7YTytrAuzWhmeLNlF52uzaERwvqxdK0Hs1EHfu+kJw+DLKhjYusiTlSq5jDHiNLlvvYgw8eK9WerrwY+66apfpnRaDfN66X/gSlGr+NfyCUefppTLiRp8AAAAAElFTkSuQmCC">
                                        </button>
                                    </span>
                                </span>
                            </span>
                        </div>
                    </div>
                    <a id="chatContainer"></a>
                    <div class="chat-input-container" [ngClass]="{'left-sidebar-collapsed': leftSidebarCollapsed && !isSmallScreen()}">
                        <!--<div class="d-flex align-items-center input-container" *ngIf="!callingOpenai && proposedEvents.length == 0">-->
                        <div class="d-flex align-items-end input-container border" id="chat-container">
                            <textarea [(ngModel)]="message" [disabled]="callingOpenai || chatRecording"
                                placeholder="{{'generics.Write a message' | translate }}..."
                                (keydown.enter)="onChatInputKeydown($event)" 
                                autoResize
                                class="mt-0 border-0 mr-2 flex-grow-1 chat-textarea"
                                rows="1"></textarea>
                            <button class="mr-1 btn btn-light chat-action-btn" title="{{'generics.Upload' | translate }}"
                                style="padding: 0.2rem 0.57rem;" [disabled]="callingOpenai || chatRecording"
                                (click)="openOptionsFiles(contentviewSelectFile)">
                                <em class="fa fa-paperclip fa-rotate-180 h-4 w-auto" width="1em" height="1em"
                                    fill="currentColor"></em>
                            </button>
                            <button *ngIf="chatVoiceSupported" 
                                class="mr-1 btn chat-action-btn" 
                                [ngClass]="{'btn-danger': chatRecording, 'btn-light': !chatRecording}"
                                [title]="chatRecording ? ('voice.Stop recording' | translate) : ('voice.Start voice input' | translate)"
                                style="padding: 0.2rem 0.57rem;" 
                                [disabled]="callingOpenai"
                                (click)="toggleChatRecording()">
                                <em *ngIf="!chatRecording" class="fa fa-microphone h-4 w-auto"></em>
                                <em *ngIf="chatRecording" class="fa fa-stop h-4 w-auto"></em>
                            </button>
                            <button class="mr-1 btn btn-dark" title="{{'generics.Submit' | translate }}"
                                style="padding: 0.2rem 0.57rem;" [disabled]="callingOpenai || chatRecording" (click)="sendMessage()">
                                <svg *ngIf="!callingOpenai" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                    fill="currentColor" viewBox="0 0 256 256" class="h-4 w-auto">
                                    <path
                                        d="M232,127.89a16,16,0,0,1-8.18,14L55.91,237.9A16.14,16.14,0,0,1,48,240a16,16,0,0,1-15.05-21.34L60.3,138.71A4,4,0,0,1,64.09,136H136a8,8,0,0,0,8-8.53,8.19,8.19,0,0,0-8.26-7.47H64.16a4,4,0,0,1-3.79-2.7l-27.44-80A16,16,0,0,1,55.85,18.07l168,95.89A16,16,0,0,1,232,127.89Z">
                                    </path>
                                </svg>
                                <em class="fa fa-spinner fa-spin fa-fw white" *ngIf="callingOpenai"></em>
                            </button>
                        </div>
                    </div>
                </div>
            </ng-container>

            <ng-container *ngIf="false">
                <!--<div class="col-xl-4 col-lg-6 col-md-6 col-12">
                        <div class="card gradient-mint">
                            <div class="card-content">
                                <div class="card-body py-0">
                                    <div class="media">
                                        <div class="media-body white text-left">
                                            <h3 class="font-medium-3 white mb-0">{{'home.donate_data' | translate }}</h3>
                                        </div>
                                        <div class="media-right white text-right">
                                            <em class="fa fa-gift font-medium-3"></em>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 ml-3 mr-3 mb-0 white">
                                <p>{{'home.donate_explanation' | translate }}</p>
                                <p>{{'home.donate_anonymity' | translate }}</p>
                                <div class="mt-2" *ngIf="!changingDonation">
                                    <button *ngIf="!isDonating" class="mb-3 mt-3 btn btn-dark mb-0" (click)="startDonating()">
                                        {{'home.start_donating' | translate }}
                                    </button>
                                    <button *ngIf="isDonating" class="mb-3 mt-3 btn btn-danger mb-0" (click)="stopDonating()">
                                        {{'home.stop_donating' | translate }}
                                    </button>
                                </div>
                                <div class="mt-3 mb-3" *ngIf="changingDonation">
                                    <em class="fa fa-spinner fa-spin fa-2x fa-fw primary"></em>
                                </div>
                            </div>
                        </div>
                    </div>-->
            </ng-container>
        </div>
        
        <!-- Panel Derecho: "Mi Maletín de Herramientas" - Desktop -->
        <div *ngIf="!isSmallScreen() && currentView === 'chat'"
             class="right-sidebar sidebar border-left"
             [ngClass]="{'collapsed': rightSidebarCollapsed}">
            <div class="sidebar-content">
                <!-- Header con título y botón de toggle -->
                <div class="sidebar-header panel-header">
                    <h2 class="panel-header-content">
                        <span>{{'tools.title' | translate}}</span>
                    </h2>
                    <button class="sidebar-toggle-btn" 
                            (click)="toggleRightSidebar()" 
                            [attr.title]="rightSidebarCollapsed ? ('generics.Open' | translate) : ('generics.Close' | translate)"
                            [attr.aria-label]="rightSidebarCollapsed ? ('generics.Open' | translate) : ('generics.Close' | translate)">
                        <i class="fa" [ngClass]="rightSidebarCollapsed ? 'fa-chevron-left' : 'fa-chevron-right'"></i>
                    </button>
                </div>
                
                <!-- Iconos cuando está plegado -->
                <div class="collapsed-icons" *ngIf="rightSidebarCollapsed">
                    <!-- Agentes -->
                    <button class="collapsed-icon-btn tool-card-red" (click)="openToolModal('dxgpt')" 
                            title="{{'dxgpt.button' | translate}}">
                        <i class="fa fa-stethoscope"></i>
                    </button>
                    <button class="collapsed-icon-btn tool-card-green" (click)="openToolModal('rarescope')" 
                            title="{{'rarescope.My Needs' | translate}}">
                        <i class="fa fa-lightbulb-o"></i>
                    </button>
                    <button class="collapsed-icon-btn tool-card-blue" (click)="openTrialGpt()" 
                            title="{{'trialgpt.title' | translate}}">
                        <i class="fa fa-flask"></i>
                    </button>
                    <button class="collapsed-icon-btn tool-card-purple" (click)="openPrepareConsultModal()" 
                            title="{{'prepareConsult.button' | translate}}">
                        <i class="fa fa-calendar-check-o"></i>
                    </button>
                    
                    <!-- Separador -->
                    <div class="collapsed-separator"></div>
                    
                    <!-- Resultados -->
                    <button class="collapsed-icon-btn result-icon-summary" (click)="getPatientSummary(false)" 
                            [disabled]="openingSummary"
                            title="{{'home.Patient Summary' | translate}}">
                        <i class="fa" [ngClass]="openingSummary ? 'fa-spinner fa-spin' : 'fa-file-text-o'"></i>
                    </button>
                    <button class="collapsed-icon-btn result-icon-notes" (click)="openNotesModal()" 
                            title="{{'notes.title' | translate}}">
                        <i class="fa fa-sticky-note"></i>
                    </button>
                    <button class="collapsed-icon-btn result-icon-diary" (click)="openDiaryModal()" 
                            title="{{'diary.title' | translate}}">
                        <i class="fa fa-calendar"></i>
                    </button>
                </div>
                
                <div class="right-sidebar-content" *ngIf="!rightSidebarCollapsed">
                    <!-- Sección Dinámica: Agentes -->
                    <div class="sidebar-section">
                        <h5 class="section-title">{{'tools.agents' | translate}}</h5>
                        <div class="tools-grid">
                            <!-- DxGPT -->
                            <button class="tool-card tool-card-red" (click)="openToolModal('dxgpt')" 
                                    title="{{'dxgpt.button' | translate}}">
                                <i class="fa fa-stethoscope tool-icon"></i>
                                <span class="tool-name">{{'dxgpt.button' | translate}}</span>
                            </button>
                            
                            <!-- Mis Necesidades (Rarescope) -->
                            <button class="tool-card tool-card-green" (click)="openToolModal('rarescope')" 
                                    title="{{'rarescope.My Needs' | translate}}">
                                <i class="fa fa-lightbulb-o tool-icon"></i>
                                <span class="tool-name">{{'rarescope.My Needs' | translate}}</span>
                            </button>
                            
                            <!-- TrialGPT -->
                            <button class="tool-card tool-card-blue" (click)="openTrialGpt()" 
                                    title="{{'trialgpt.title' | translate}}">
                                <i class="fa fa-flask tool-icon"></i>
                                <span class="tool-name">{{'trialgpt.button' | translate}}</span>
                            </button>
                            
                            <!-- Preparar Consulta -->
                            <div class="tool-card tool-card-purple tool-card-with-edit">
                                <div class="tool-card-main" (click)="sendQuickPrepareConsult()" 
                                     title="{{'prepareConsult.button' | translate}}">
                                    <i class="fa fa-calendar-check-o tool-icon"></i>
                                    <span class="tool-name">{{'prepareConsult.button' | translate}}</span>
                                </div>
                                <button class="tool-card-edit-btn" (click)="openPrepareConsultModal(); $event.stopPropagation()"
                                        title="{{'prepareConsult.editTooltip' | translate}}">
                                    <i class="fa fa-pencil"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Enlace a Ideas y sugerencias -->
                        <div class="explore-options-link" (click)="showOptionsMenu(ContentOptionsMenu)"
                             title="{{'tools.exploreOptionsDesc' | translate}}">
                            <i class="fa fa-lightbulb-o"></i>
                            <span>{{'tools.exploreOptions' | translate}}</span>
                            <i class="fa fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <!-- Sección de Salida: Resultados -->
                    <div class="sidebar-section">
                        <h5 class="section-title">{{'tools.results' | translate}}</h5>
                        
                        <!-- Resumen del Paciente -->
                        <div class="result-card result-card-summary" (click)="getPatientSummary(false)" [class.disabled]="openingSummary">
                            <div class="result-card-icon">
                                <i class="fa" [ngClass]="openingSummary ? 'fa-spinner fa-spin' : 'fa-file-text-o'"></i>
                            </div>
                            <div class="result-card-content">
                                <h6 class="result-card-title">{{'home.Patient Summary' | translate}}</h6>
                                <p class="result-card-preview" *ngIf="openingSummary">
                                    {{'generics.Loading' | translate}}...
                                </p>
                                <p class="result-card-preview" *ngIf="!openingSummary">
                                    {{'tools.clickToView' | translate}}
                                </p>
                            </div>
                            <div class="result-card-arrow">
                                <i class="fa" [ngClass]="openingSummary ? 'fa-spinner fa-spin' : 'fa-chevron-right'"></i>
                            </div>
                        </div>
                        
                        <!-- Mis Notas -->
                        <div class="result-card result-card-notes" (click)="openNotesModal()">
                            <div class="result-card-icon">
                                <i class="fa fa-sticky-note"></i>
                            </div>
                            <div class="result-card-content">
                                <h6 class="result-card-title">{{'notes.title' | translate}}</h6>
                                <p class="result-card-preview">
                                    <span *ngIf="notes.length > 0">{{notes.length}} {{'tools.notesCount' | translate}}</span>
                                    <span *ngIf="notes.length === 0" class="text-muted">{{'tools.noNotes' | translate}}</span>
                                </p>
                            </div>
                            <div class="result-card-arrow">
                                <i class="fa fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <!-- Diario -->
                        <div class="result-card result-card-diary" (click)="openDiaryModal()">
                            <div class="result-card-icon">
                                <i class="fa fa-calendar"></i>
                            </div>
                            <div class="result-card-content">
                                <h6 class="result-card-title">{{'diary.title' | translate}}</h6>
                                <p class="result-card-preview text-muted">
                                    {{'tools.clickToView' | translate}}
                                </p>
                            </div>
                            <div class="result-card-arrow">
                                <i class="fa fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel Derecho Móvil: "Mi Maletín de Herramientas" - Siempre en DOM para animación -->
        <div *ngIf="isSmallScreen()"
             class="right-sidebar sidebar border-left"
             [ngClass]="{'mobile-fullscreen': rightSidebarOpenMobile}">
            <div class="sidebar-content">
                <!-- Header con título y botón de toggle -->
                <div class="sidebar-header panel-header">
                    <h2 class="panel-header-content">
                        <span>{{'tools.title' | translate}}</span>
                    </h2>
                    <button class="sidebar-toggle-btn" 
                            *ngIf="!isSmallScreen()"
                            (click)="toggleRightSidebar()" 
                            [attr.title]="rightSidebarCollapsed ? ('generics.Open' | translate) : ('generics.Close' | translate)"
                            [attr.aria-label]="rightSidebarCollapsed ? ('generics.Open' | translate) : ('generics.Close' | translate)">
                        <i class="fa" [ngClass]="rightSidebarCollapsed ? 'fa-chevron-left' : 'fa-chevron-right'"></i>
                    </button>
                </div>
                
                <!-- Iconos cuando está plegado -->
                <div class="collapsed-icons" *ngIf="rightSidebarCollapsed && !isSmallScreen()">
                    <!-- Agentes -->
                    <button class="collapsed-icon-btn tool-card-red" (click)="openToolModal('dxgpt')" 
                            title="{{'dxgpt.button' | translate}}">
                        <i class="fa fa-stethoscope"></i>
                    </button>
                    <button class="collapsed-icon-btn tool-card-green" (click)="openToolModal('rarescope')" 
                            title="{{'rarescope.My Needs' | translate}}">
                        <i class="fa fa-lightbulb-o"></i>
                    </button>
                    <button class="collapsed-icon-btn tool-card-blue" (click)="openTrialGpt()" 
                            title="{{'trialgpt.title' | translate}}">
                        <i class="fa fa-flask"></i>
                    </button>
                    <button class="collapsed-icon-btn tool-card-purple" (click)="openPrepareConsultModal()" 
                            title="{{'prepareConsult.button' | translate}}">
                        <i class="fa fa-calendar-check-o"></i>
                    </button>
                    
                    <!-- Separador -->
                    <div class="collapsed-separator"></div>
                    
                    <!-- Resultados -->
                    <button class="collapsed-icon-btn result-icon-summary" (click)="getPatientSummary(false)" 
                            [disabled]="openingSummary"
                            title="{{'home.Patient Summary' | translate}}">
                        <i class="fa" [ngClass]="openingSummary ? 'fa-spinner fa-spin' : 'fa-file-text-o'"></i>
                    </button>
                    <button class="collapsed-icon-btn result-icon-notes" (click)="openNotesModal()" 
                            title="{{'notes.title' | translate}}">
                        <i class="fa fa-sticky-note"></i>
                    </button>
                    <button class="collapsed-icon-btn result-icon-diary" (click)="openDiaryModal()" 
                            title="{{'diary.title' | translate}}">
                        <i class="fa fa-calendar"></i>
                    </button>
                </div>
                
                <div class="right-sidebar-content" *ngIf="!rightSidebarCollapsed">
                    
                    <!-- Sección Dinámica: Agentes -->
                    <div class="sidebar-section">
                        <h5 class="section-title">{{'tools.agents' | translate}}</h5>
                        <div class="tools-grid">
                            <!-- DxGPT -->
                            <button class="tool-card tool-card-red" (click)="openToolModal('dxgpt')" 
                                    title="{{'dxgpt.button' | translate}}">
                                <i class="fa fa-stethoscope tool-icon"></i>
                                <span class="tool-name">{{'dxgpt.button' | translate}}</span>
                            </button>
                            
                            <!-- Mis Necesidades (Rarescope) -->
                            <button class="tool-card tool-card-green" (click)="openToolModal('rarescope')" 
                                    title="{{'rarescope.My Needs' | translate}}">
                                <i class="fa fa-lightbulb-o tool-icon"></i>
                                <span class="tool-name">{{'rarescope.My Needs' | translate}}</span>
                            </button>
                            
                            <!-- TrialGPT -->
                            <button class="tool-card tool-card-blue" (click)="openTrialGpt()" 
                                    title="{{'trialgpt.title' | translate}}">
                                <i class="fa fa-flask tool-icon"></i>
                                <span class="tool-name">{{'trialgpt.button' | translate}}</span>
                            </button>
                            
                            <!-- Preparar Consulta -->
                            <div class="tool-card tool-card-purple tool-card-with-edit">
                                <div class="tool-card-main" (click)="sendQuickPrepareConsult()" 
                                     title="{{'prepareConsult.button' | translate}}">
                                    <i class="fa fa-calendar-check-o tool-icon"></i>
                                    <span class="tool-name">{{'prepareConsult.button' | translate}}</span>
                                </div>
                                <button class="tool-card-edit-btn" (click)="openPrepareConsultModal(); $event.stopPropagation()"
                                        title="{{'prepareConsult.editTooltip' | translate}}">
                                    <i class="fa fa-pencil"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Enlace a Ideas y sugerencias -->
                        <div class="explore-options-link" (click)="showOptionsMenu(ContentOptionsMenu)"
                             title="{{'tools.exploreOptionsDesc' | translate}}">
                            <i class="fa fa-lightbulb-o"></i>
                            <span>{{'tools.exploreOptions' | translate}}</span>
                            <i class="fa fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <!-- Sección de Salida: Resultados -->
                    <div class="sidebar-section">
                        <h5 class="section-title">{{'tools.results' | translate}}</h5>
                        
                        <!-- Resumen del Paciente -->
                        <div class="result-card result-card-summary" (click)="getPatientSummary(false)" [class.disabled]="openingSummary">
                            <div class="result-card-icon">
                                <i class="fa" [ngClass]="openingSummary ? 'fa-spinner fa-spin' : 'fa-file-text-o'"></i>
                            </div>
                            <div class="result-card-content">
                                <h6 class="result-card-title">{{'home.Patient Summary' | translate}}</h6>
                                <p class="result-card-preview" *ngIf="openingSummary">
                                    {{'generics.Loading' | translate}}...
                                </p>
                                <p class="result-card-preview" *ngIf="!openingSummary">
                                    {{'tools.clickToView' | translate}}
                                </p>
                            </div>
                            <div class="result-card-arrow">
                                <i class="fa" [ngClass]="openingSummary ? 'fa-spinner fa-spin' : 'fa-chevron-right'"></i>
                            </div>
                        </div>
                        
                        <!-- Mis Notas -->
                        <div class="result-card result-card-notes" (click)="openNotesModal()">
                            <div class="result-card-icon">
                                <i class="fa fa-sticky-note"></i>
                            </div>
                            <div class="result-card-content">
                                <h6 class="result-card-title">{{'notes.title' | translate}}</h6>
                                <p class="result-card-preview">
                                    <span *ngIf="notes.length > 0">{{notes.length}} {{'tools.notesCount' | translate}}</span>
                                    <span *ngIf="notes.length === 0" class="text-muted">{{'tools.noNotes' | translate}}</span>
                                </p>
                            </div>
                            <div class="result-card-arrow">
                                <i class="fa fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <!-- Diario -->
                        <div class="result-card result-card-diary" (click)="openDiaryModal()">
                            <div class="result-card-icon">
                                <i class="fa fa-calendar"></i>
                            </div>
                            <div class="result-card-content">
                                <h6 class="result-card-title">{{'diary.title' | translate}}</h6>
                                <p class="result-card-preview text-muted">
                                    {{'tools.clickToView' | translate}}
                                </p>
                            </div>
                            <div class="result-card-arrow">
                                <i class="fa fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
</ng-container>

<ng-template #timelineModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'timeline.Timeline' | translate }}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <!-- Aquí va todo el contenido del timeline que tenías antes -->
        <div class="">
            <div class="card-content" style="background-color: #d9d9d9;">
                <div class="card-body py-0">
                    <div class="media">
                        <div class="media-body text-left">
                            <span>
                                <h3 class="font-medium-3 mb-0">
                                    {{timeline.length}}</h3>
                            </span>
                            <span>{{'timeline.Timeline' | translate }}</span>
                        </div>
                        <div class="media-right text-right">
                            <button class="btn btn-white btn-sm mb-2" (click)="toggleFilters()">
                                <span *ngIf="!showFilters">{{'timeline.Show filters' | translate }}</span>
                                <span *ngIf="showFilters">{{'timeline.Hide filters' | translate }}</span>
                            </button>
                        </div>
                    </div>
                    <div class="row d-block-inline" *ngIf="showFilters">
                        <div class="col-md-12">{{'timeline.Filter by' | translate }}</div>
                        <div class="col-md-12 customcol aligself-start">
                            <mat-form-field>
                                <mat-label>{{'timeline.Start date' | translate }}</mat-label>
                                <input readonly matInput [matDatepicker]="picker" [(ngModel)]="startDate"
                                    (dateChange)="filterEvents()" (click)="picker.open()">
                                <button *ngIf="startDate != null" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="resetStartDate(null)" style="position: absolute; left: 30px;">
                                    <em class="fa fa-trash danger"></em>
                                </button>
                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker touchUi="true" #picker></mat-datepicker>
                            </mat-form-field>
                        </div>
                        <div class="col-md-12 customcol aligself-start">
                            <mat-form-field>
                                <mat-label>{{'timeline.End date' | translate }}</mat-label>
                                <input readonly matInput [matDatepicker]="picker2" [(ngModel)]="endDate"
                                    (dateChange)="filterEvents()" (click)="picker2.open()">
                                <button *ngIf="endDate != null" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="resetEndDate(null)" style="position: absolute; left: 30px;">
                                    <em class="fa fa-trash danger"></em>
                                </button>
                                <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                                <mat-datepicker touchUi="true" #picker2></mat-datepicker>
                            </mat-form-field>
                        </div>
                        <div class="col-md-12 customcol aligself-start">
                            <mat-form-field>
                                <mat-label>{{'timeline.Event type' | translate }}</mat-label>
                                <mat-select [(ngModel)]="selectedEventType" (selectionChange)="filterEvents()">
                                    <mat-option [value]="null">{{'timeline.All Event Types' | translate }}</mat-option>
                                    <mat-option value="diagnosis">{{'timeline.Diagnoses' | translate }} 🩺</mat-option>
                                    <mat-option value="treatment">{{'timeline.Treatment' | translate }} 💉</mat-option>
                                    <mat-option value="test">{{'timeline.Tests' | translate }} 🔬</mat-option>
                                    <mat-option value="appointment">{{'events.appointment' | translate }}
                                        📅</mat-option>
                                    <mat-option value="symptom">{{'timeline.Symptoms' | translate }} 🤒</mat-option>
                                    <mat-option value="medication">{{'timeline.Medications' | translate }}
                                        💊</mat-option>
                                    <mat-option value="other">{{'timeline.Other' | translate }} 🔍</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-2">
                <div class="timeline" *ngIf="groupedEvents.length > 0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="pointer" (click)="toggleEventOrder()"
                            style="text-decoration: underline !important;color: #b30000;">
                            {{'generics.Sort' | translate }} <em class="fa" [class.fa-arrow-down]="!isOldestFirst"
                                [class.fa-arrow-up]="isOldestFirst"></em>
                        </span>
                        <div class="d-flex gap-2">
                            <div ngbDropdown class="btn-group mr-2" role="group">
                                <button type="button" class="btn btn-sm btn-white" ngbDropdownToggle>
                                    <i class="fa fa-download"></i> {{'timeline.Export' | translate }}
                                </button>
                                <div ngbDropdownMenu class="dropdown-menu-right">
                                    <button class="dropdown-item" (click)="copyTimelineToClipboard()">
                                        <i class="fa fa-copy mr-2"></i> {{'timeline.Copy to clipboard' | translate }}
                                    </button>
                                    <button class="dropdown-item" (click)="exportTimelineToCSV()">
                                        <i class="fa fa-file-csv mr-2"></i> {{'timeline.Export to CSV' | translate }}
                                    </button>
                                    <button class="dropdown-item" (click)="exportTimelineToPDF()">
                                        <i class="fa fa-file-pdf mr-2"></i> {{'timeline.Export to PDF' | translate }}
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-white" (click)="newMedicalEventTimeline()">
                                <i class="fa fa-plus"></i> {{'events.New Medical Event' | translate }}
                            </button>
                        </div>
                    </div>
                    <div *ngFor="let group of groupedEvents">
                        <div class="timeline-month-title">
                            <ng-container *ngIf="group.monthYear; else noDateTitle">
                                {{ group.monthYear | date: 'MMMM y' : '' : lang }}
                            </ng-container>
                            <ng-template #noDateTitle>
                                <span class="text-danger">
                                    <i class="fa fa-exclamation-triangle mr-1"></i> 
                                    {{'timeline.Missing date' | translate}}
                                </span>
                            </ng-template>
                        </div>
                        <div class="timeline-item" *ngFor="let event of group.events" [ngClass]="{'timeline-item-no-date': !group.monthYear}">
                            <div class="timeline-dot" [ngClass]="{'timeline-dot-danger': !group.monthYear}"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-0">
                                            <span
                                                title="{{getEventTypeDisplay(event.key)}}">{{getEventTypeIcon(event.key)}}</span>
                                            {{ event.name }}
                                        </p>
                                        <small class="text-muted">
                                            <span *ngIf="!group.monthYear" class="d-block font-italic mb-1">
                                                {{'timeline.Please add a date to this event' | translate}}
                                            </span>
                                            <span *ngIf="group.monthYear && !event.dateEnd">{{ event.date | date }}</span>
                                            <span *ngIf="group.monthYear && event.dateEnd">{{ event.date | date }} - {{ event.dateEnd | date }}</span>
                                            <span *ngIf="event.dateConfidence === 'estimated'" class="badge badge-warning ml-1" style="font-size: 0.7rem; vertical-align: middle;">
                                                {{'timeline.Estimated' | translate}}
                                            </span>
                                        </small>
                                    </div>
                                    <button class="btn btn-link btn-sm" [matMenuTriggerFor]="menu"
                                        aria-label="More options">
                                        <i class="fa fa-ellipsis-v"></i>
                                    </button>
                                    <mat-menu #menu="matMenu">
                                        <button mat-menu-item (click)="editMedicalEventTimeline(event)">
                                            <i class="fa fa-edit mr-2"></i>
                                            {{'generics.Edit' | translate }}
                                        </button>
                                        <button mat-menu-item (click)="deleteMedicalEvent(event)">
                                            <i class="fa fa-trash mr-2 text-danger"></i>
                                            {{'generics.Delete' | translate }}
                                        </button>
                                    </mat-menu>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="groupedEvents.length == 0">
                    <p>{{'timeline.There are no events' | translate }}</p>
                </div>
            </div>
        </div>
    </div>
</ng-template>
<ng-template #contentSummaryDoc id="contentSummaryDoc" let-c="close" let-d="dismiss" appendTo="body">
    <a id="contentHeader"></a>
    <div class="modal-header border-bottom-0" id="idHeader">
        <button type="button" class="close position-absolute" style="right: 1rem; top: 1rem;" aria-label="Close"
            (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
        <div class="content-header text-left row w-100 align-items-center position-relative">

            <div class="col-12 col-xl-9 d-flex flex-column">
                <h4 class="mb-0 editable-title" *ngIf="!editingTitle" (click)="startEditing()">
                    <span class="title-text">{{actualDoc.title}}</span>
                    <span class="edit-overlay">
                        <em class="fa fa-pencil"></em>
                        {{'generics.Change file name' | translate}}
                    </span>
                </h4>
                <div *ngIf="editingTitle" class="d-flex align-items-center">
                    <input #titleInput autoFocus type="text" 
                        class="editable-title-input"
                        [style.width.px]="getInputWidth(getFileNameWithoutExtension(actualDoc.title))"
                        [ngModel]="getFileNameWithoutExtension(actualDoc.title)"
                        (ngModelChange)="actualDoc.title = $event + actualDoc.title.substring(actualDoc.title.lastIndexOf('.'))"
                        (blur)="saveTitle()" (keyup.enter)="saveTitle()" (keyup.escape)="cancelEditing()"
                        (input)="adjustInputWidth($event)"
                        (ngAfterViewInit)="titleInput.focus(); titleInput.select()">
                </div>
                <div>
                    <small><strong>{{'generics.Uploaded on' | translate }}:</strong> {{actualDoc.date | date}}</small>
                    <small *ngIf="actualDoc.originaldate" class="ml-2"><strong>{{'generics.Report date' | translate
                            }}:</strong> {{actualDoc.originaldate | date}}</small>
                    <span class="pointer" (click)="openUpdateDocDate(actualDoc, PanelChangeDate)"
                        title="{{ 'dashboardpatient.Update document date' | translate }}">
                        <em class="fa fa-edit ml-1"></em>
                    </span>
                </div>
            </div>
            <div
                class="col-12 col-xl-3 d-flex justify-content-start justify-content-xl-end align-items-center mt-2 mt-xl-0">
                <span class="dropdown mr-2" ngbDropdown display="dynamic" placement="auto">
                    <button class="btn btn-white" id="dropdownSympt" ngbDropdownToggle
                        title="{{'generics.Options' | translate }}">
                        {{'generics.Options' | translate }}
                    </button>
                    <div ngbDropdownMenu aria-labelledby="dropdownSympt" class="dropdown">
                        <a class="dropdown-item" (click)="getBlobUrl(actualDoc.url)">
                            <i class="fa-1_5x fa fa-eye"></i><span class="ml-2">{{'messages.m5.5' | translate }}</span>
                        </a>
                        <a class="dropdown-item"
                            href="{{accessToken.blobAccountUrl}}{{accessToken.containerName}}/{{actualDoc.url}}{{accessToken.sasToken}}"
                            target="_blank" download>
                            <i class="fa-1_5x fa fa-download"></i><span class="ml-2">{{'generics.Download' | translate
                                }}</span>
                        </a>
                        <div class="dropdown-divider" *ngIf="actualDoc.isOwner"></div>
                        <a *ngIf="actualDoc.status != 'pending' && actualDoc.status != 'inProcess' && actualDoc.isOwner"
                            class="dropdown-item danger" href="javascript:;" (click)="deleteDoc(actualDoc);">
                            <i class="fa-1_5x fa fa-trash"></i><span class="ml-2">{{'generics.Delete' | translate
                                }}</span>
                        </a>
                    </div>
                </span>
            </div>
        </div>
    </div>
    <mat-dialog-content class="mt-2">
        <mat-tab-group [(selectedIndex)]="selectedIndexTab">
            <mat-tab label="{{'generics.Summary' | translate }}">
                <div class="modal-body content-wrapper p-2" id="idBody">
                    <div class="p-1">
                        <div>
                            <span class="animate-bottom" *ngIf="showButtonScroll" id="buttomScroll">
                                <button type="button" class="btn btn-dark round mb-0" (click)="goToTop()">{{'generics.Go
                                    top' | translate }}</button>
                            </span>
                            <span [innerHTML]="summaryDoc | safe: 'html'"></span>
                            <p class="text-muted pt-3 mb-0">{{'generics.generated by artificial intelligence' |
                                translate }}</p>
                        </div>
                    </div>
                </div>
                <!--<div class="modal-footer" id="idFooter" *ngIf="needFeedback">
                    <app-feedback-summary-page [documents]="[actualDoc]" [type]="'individual'" (close)="handleClose2()">
                    </app-feedback-summary-page>
                </div>-->
            </mat-tab>
            <mat-tab label="{{'events.title' | translate }}">
                <div class="modal-body content-wrapper p-2">
                    <div *ngIf="eventsDoc.length>0">
                        <p class="instructions">
                            {{'events.review_validate_events' | translate }}
                        </p>
                        <div class="d-flex justify-content-end mb-2">
                            <div>
                                <span class="badge badge-events bg-danger mr-1"><span class="fa fa-times"></span>
                                    {{'events.incorrect' | translate }}</span>
                                <span class="badge badge-events bg-success mr-1"><span class="fa fa-check"></span>
                                    {{'events.present' | translate }}</span>
                                <span class="badge badge-events bg-warning"><span class="fa fa-calendar"></span>
                                    {{'events.past' | translate }}</span>
                            </div>
                        </div>
                        <ul class="list-group">
                            <li *ngFor="let event of eventsDoc" class="list-group-item">
                                <div class="d-flex justify-content-between" style="align-items: flex-start;">
                                    <div class="pr-1">
                                        <p class="mb-0">
                                            <span title="{{'timeline.Diagnoses' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'diagnosis'">🩺 </span>
                                            <span title="{{'timeline.Treatment' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'treatment'">💉 </span>
                                            <span title="{{'timeline.Tests' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'test'">🔬 </span>
                                            <span title="{{'events.appointment' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'appointment'">📅 </span>
                                            <span title="{{'timeline.Symptoms' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'symptom'">🤒 </span>
                                            <span title="{{'timeline.Medications' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'medication'">💊 </span>
                                            <span title="{{'timeline.Other' | translate }}" class="fa-1_1x"
                                                *ngIf="event.key == 'other'">🔍 </span>
                                            <span class="">{{ event.name }}</span>
                                        </p>
                                        <p>
                                            <span *ngIf="!event.dateEnd">{{ event.date | date }}</span>
                                            <span *ngIf="event.dateEnd">{{ event.date | date }} - {{ event.dateEnd | date }}</span>
                                        </p>
                                        <span (click)="explainMedicalEvent(event.name)" class="pointer ml-1"><span
                                                class="fa fa-question-circle-o fa-1_3x"></span></span>
                                        <span (click)="editMedicalEvent(event)" class="pointer ml-1"><span
                                                class="fa fa-pencil fa-1_3x"></span></span>
                                        <span (click)="deleteMedicalEvent(event)" class="pointer ml-1"><span
                                                class="fa fa-trash fa-1_3x"></span></span>
                                    </div>
                                    <div class="mt-1 btn-group btn-group-toggle" ngbRadioGroup
                                        [(ngModel)]="event.status">
                                        <label class="btn btn-outline-danger" ngbButtonLabel>
                                            <input type="radio" ngbButton [value]="'deleted'"
                                                (change)="updateEventStatus(event, 'deleted')"> <span
                                                class="fa fa-times"></span>
                                        </label>
                                        <label class="btn btn-outline-success" ngbButtonLabel>
                                            <input type="radio" ngbButton [value]="'true'"
                                                (change)="updateEventStatus(event, 'true')"> <span
                                                class="fa fa-check"></span>
                                        </label>
                                        <label class="btn btn-outline-warning" ngbButtonLabel>
                                            <input type="radio" ngbButton [value]="'false'"
                                                (change)="updateEventStatus(event, 'false')"> <span
                                                class="fa fa-calendar"></span>
                                        </label>
                                    </div>
                                </div>
                                <div *ngIf="event.notes">
                                    <p class="mt-2 mb-0">{{'notes.title' | translate }}: {{event.notes}}</p>
                                </div>
                            </li>
                        </ul>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span>{{'events.Missing' | translate }}</span>
                            <button class="btn btn-white" (click)="newMedicalEvent(actualDoc)">{{'events.New Medical
                                Event' | translate }}</button>
                        </div>
                    </div>
                    <div *ngIf="eventsDoc.length==0">
                        <p>{{'home.No events have been detected' | translate }}</p>
                        <button class="btn btn-white" (click)="newMedicalEvent(actualDoc)">{{'events.New Medical Event' |
                            translate }}</button>
                    </div>

                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-dialog-content>
    <div class="modal-footer" id="idFooter">
        <button class="btn btn-dark m-2" (click)="closeModal()">{{'generics.Close' |translate }}</button>
    </div>
</ng-template>
<ng-template #contentviewDoc id="contentviewDoc" let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header" id="idHeader">
        <div class="content-header text-left">
            <h4 class="mb-0">{{actualDoc.title}}</h4>
            <small><strong>{{'generics.Uploaded on' | translate }}:</strong> {{actualDoc.date | date}}</small>
            <small *ngIf="actualDoc.originaldate" class="ml-2"><strong>{{'generics.Report date' | translate }}:</strong>
                {{actualDoc.originaldate | date}}</small>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body content-wrapper p-2" id="idBody">
        <div class="p-1">
            <div>
                <span class="animate-bottom" *ngIf="showButtonScroll" id="buttomScroll">
                    <button type="button" class="btn btn-dark round mb-0" (click)="goToTop()">{{'generics.Go top' |
                        translate }}</button>
                </span>
                <div class="">
                    <div *ngIf="resultText.length >=5" style="text-align: justify;" class="textExtractedNcr"
                        [innerHTML]="resultText | safe: 'html'"></div>
                    <div *ngIf="resultText.length < 5">
                        {{'home.placeholderError' | translate }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #contentviewSummary id="contentviewSummary" let-c="close" let-d="dismiss" appendTo="body">
    <a id="contentHeader"></a>
    <div class="modal-header" id="idHeader">
        <div class="w-100">
            <!-- Title and close button container -->
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="content-header text-left">
                    <h4 class="mb-0">{{'messages.m6.2' | translate }}</h4>
                    <small>{{summaryDate | date}}</small>
                </div>
                <button type="button" class="close" aria-label="Close" (click)="closeModal();">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Action buttons container -->
            <div class="d-flex flex-wrap">
                <button class="btn btn-sm btn-white mr-2 mb-2" (click)="addNoteWithMessage(summaryJson.data)"
                    [disabled]="savingNote" title="{{'notes.Save to notes' | translate }}">
                    <em class="fa-solid fa-thumbtack mr-1"></em>
                    {{'notes.Save to notes' | translate }}
                </button>

                <button class="btn btn-sm btn-white mr-2 mb-2" (click)="copymsg(summaryJson.data)">
                    <em class="fa fa-copy"></em>
                    {{'generics.Copy' | translate }}
                </button>

                <button class="btn btn-sm btn-white mb-2" (click)="downloadPDF()" [disabled]="generatingPDF">
                    <span *ngIf="!generatingPDF">
                        <em class="fa fa-download"></em>
                        {{'generics.Download' | translate }} PDF
                    </span>
                    <span *ngIf="generatingPDF">
                        <i class="fa fa-spinner fa-spin fa-fw primary"></i>
                        {{'generics.Please wait' | translate }} PDF
                    </span>
                </button>
            </div>
        </div>
    </div>
    <div class="modal-body content-wrapper p-2" id="idBody">
        <div class="p-1">
            <div>
                <span class="animate-bottom" *ngIf="showButtonScroll" id="buttomScroll">
                    <button type="button" class="btn btn-dark round mb-0" (click)="goToTop()">{{'generics.Go top' |
                        translate }}</button>
                </span>
                <div *ngIf="summaryJson && !summaryJson.data">
                    <div class="mt-2">
                        <p>
                            <strong class="mr-1">{{'summary.Name' | translate }}:</strong>
                            <span *ngIf="summaryJson.Name!=''">{{summaryJson.Name}}</span>
                            <span *ngIf="summaryJson.Name==''">-</span>
                        </p>
                        <p>
                            <strong class="mr-1">{{'summary.Age' | translate }}:</strong>
                            <span *ngIf="summaryJson.Age!=''">{{summaryJson.Age}}</span>
                            <span *ngIf="summaryJson.Age==''">-</span>
                        </p>
                        <p>
                            <strong class="mr-1">{{'summary.Gender' | translate }}:</strong>
                            <span *ngIf="summaryJson.Gender!=''">{{summaryJson.Gender}}</span>
                            <span *ngIf="summaryJson.Gender==''">-</span>
                        </p>
                    </div>
                    <!-- <div class="mt-3">
                        <h5>{{'summary.CurrentStatus' | translate }}</h5> 

                        <span *ngIf="isString(summaryJson.CurrentStatus)">
                            {{summaryJson.CurrentStatus}}
                        </span>

                        <ng-container *ngIf="isObject(summaryJson.CurrentStatus)">
                            <p *ngFor="let key of getObjectKeys(summaryJson.CurrentStatus)">
                            <strong class="mr-1">{{key | translate}}:</strong>
                            <span *ngIf="isDate(summaryJson.CurrentStatus[key])">{{summaryJson.CurrentStatus[key] | date}}</span>
                            <span *ngIf="!isDate(summaryJson.CurrentStatus[key])">{{summaryJson.CurrentStatus[key]}}</span>
                            </p>
                        </ng-container>

                        <span *ngIf="!summaryJson.CurrentStatus || summaryJson.CurrentStatus === ''">-</span>
                    </div> -->
                    <div class="mt-3">
                        <h5>{{'summary.Diagnoses' | translate }}</h5>
                        <span *ngIf="summaryJson.Diagnoses.length>0">
                            <ul>
                                <li *ngFor="let item of summaryJson.Diagnoses" class="dot">{{item}}</li>
                            </ul>
                        </span>
                        <span *ngIf="summaryJson.Diagnoses.length==0">
                            <span class="ml-2">{{'summary.No observations' | translate }}</span>
                        </span>
                    </div>
                    <div class="mt-3">
                        <h5>{{'summary.Medication' | translate }}</h5>
                        <span *ngIf="summaryJson.Medication.length>0">
                            <ul>
                                <li *ngFor="let item of summaryJson.Medication" class="dot">{{item}}</li>
                            </ul>
                        </span>
                        <span *ngIf="summaryJson.Medication.length==0">
                            <span class="ml-2">{{'summary.No observations' | translate }}</span>
                        </span>
                    </div>
                    <!-- <div class="mt-3">
                        <h5 *ngIf="summaryJson.Treatments.length>0">{{'summary.Treatments' | translate }}</h5> 
                        <span *ngIf="summaryJson.Treatments.length>0">
                            <ul>
                                <li *ngFor="let item of summaryJson.Treatments" class="dot">{{item}}</li>
                            </ul>
                        </span> 
                        <span *ngIf="summaryJson.Treatments.length==0">
                            <span class="ml-2">{{'summary.No observations' | translate }}</span>
                        </span> 
                    </div> -->
                    <!-- <div class="mt-3">
                        <h5>{{'summary.LaboratoryFindings' | translate }}</h5> 
                        <span *ngIf="summaryJson.LaboratoryFindings.length>0">
                            <ul>
                                <li *ngFor="let item of summaryJson.LaboratoryFindings" class="dot">{{item}}</li>
                            </ul>
                        </span> 
                        <span *ngIf="summaryJson.LaboratoryFindings.length==0">
                            <span class="ml-2">{{'summary.No observations' | translate }}</span>
                        </span> 
                    </div> -->
                    <div class="mt-3 mb-4">
                        <h5>{{'summary.AdditionalInformation' | translate }}</h5>
                        <ng-container *ngIf="summaryJson.AdditionalInformation">
                            <ng-container *ngIf="isString(summaryJson.AdditionalInformation); else notString">
                                {{summaryJson.AdditionalInformation}}
                            </ng-container>
                            <ng-template #notString>
                                <ng-container *ngIf="summaryJson.AdditionalInformation.length > 0; else noObservations">
                                    <ul>
                                        <li *ngFor="let item of summaryJson.AdditionalInformation" class="dot">
                                            <p class="mb-0"><strong>{{item.date | date}} - {{ ('steps.' + item.type) |
                                                    translate }}</strong></p>
                                            <p>{{item.event}}</p>
                                        </li>
                                    </ul>
                                </ng-container>
                                <ng-template #noObservations>
                                    <span class="ml-2">{{'summary.No observations' | translate }}</span>
                                </ng-template>
                            </ng-template>
                        </ng-container>
                    </div>
                    <p class="text-muted pt-3 mb-0">{{'generics.generated by artificial intelligence' | translate }}</p>
                </div>
                <div *ngIf="summaryJson && summaryJson.data" class="summary-content">
                    <div [innerHTML]="summaryJson.data | safe: 'html'"></div>
                </div>
                <div *ngIf="!summaryJson">
                    <p>{{'home.placeholderError' | translate }}</p>
                </div>
            </div>
        </div>
    </div>
    <!--<div class="modal-footer" id="idFooter" *ngIf="needFeedback">
        <app-feedback-summary-page [documents]="docs" [type]="'general'" (close)="handleClose()">
        </app-feedback-summary-page>
    </div>-->
</ng-template>

<ng-template #contentviewProposedEvents let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header" id="idHeader">
        <div class="content-header text-left">
            <h4 class="mb-0">{{'events.title' | translate }}</h4>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body content-wrapper p-2" id="idBody">
        <div class="p-1">
            <form action="#" class="form form-horizontal" [formGroup]="eventsForm">
                <div class="form-body">
                    <div class="">
                        <div class="">
                            <div class="form-group">
                                <label>{{'generics.Name' | translate }}</label>
                                <input type="text" class="col-12 form-control" id="numericos2" formControlName="name"
                                    [ngClass]="{ 'is-invalid': submitted && ef.name.errors }" name="numericos2">
                                <small class="form-text text-muted danger"
                                    *ngIf="submitted && ef.name.errors">{{'generics.required' |
                                    translate }}</small>
                            </div>
                        </div>
                        <div class="">
                            <div class="form-group">
                                <label class="mb-0">{{'generics.Date' | translate }}</label>
                                <div class="">
                                    <mat-form-field class="mr-sm-24" fxFlex>
                                        <input matInput class="grey" readonly [matDatepicker]="picker"
                                            autocomplete="off" name="date" formControlName="date">
                                        <button *ngIf="eventsForm.value.endDate!=null" matSuffix mat-icon-button
                                            aria-label="Clear" (click)="eventsForm.controls['endDate'].setValue(null)"
                                            style="position: absolute; left: 30px;">
                                            <em class="fa fa-trash danger"></em>
                                        </button>
                                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                        <mat-datepicker touchUi="true" [startAt]="date" #picker></mat-datepicker>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="form-group">
                                <label for="key">{{ 'events.Type' | translate }}</label>
                                <select class="form-control" id="key" formControlName="key">
                                    <option value="">{{ 'timeline.Select type' | translate }}</option>
                                    <option value="diagnosis">🩺 {{ 'timeline.Diagnoses' | translate }}</option>
                                    <option value="treatment">💉 {{ 'timeline.Treatment' | translate }}</option>
                                    <option value="test">🔬 {{ 'timeline.Tests' | translate }}</option>
                                    <option value="appointment">📅 {{ 'events.appointment' | translate }}</option>
                                    <option value="symptom">🤒 {{ 'timeline.Symptoms' | translate }}</option>
                                    <option value="medication">💊 {{ 'timeline.Medications' | translate }}</option>
                                    <option value="activity">🏃 {{ 'timeline.Activity' | translate }}</option>
                                    <option value="reminder">🔔 {{ 'timeline.Reminder' | translate }}</option>
                                    <option value="other">🔍 {{ 'timeline.Other' | translate }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="">
                            <div class="form-group">
                                <label>{{'generics.notes' | translate }}</label>
                                <textarea maxlength="150" name="notes" formControlName="notes"
                                    placeholder="{{'generics.Write down any details' | translate }}"
                                    class="autoajustable form-control"></textarea>
                            </div>
                        </div>
                    </div>

                </div>
            </form>
            <div class="col-md-12 center-elements" *ngIf="!submitted">
                <button type="button" class="btn btn-secondary mr-1" (click)="cancelData();">{{'generics.Cancel' |
                    translate }}</button>
                <button type="button" class="btn btn-dark ml-1" (click)="saveData(true, true);">{{'generics.Save' |
                    translate }}</button>
            </div>
            <div class="col-md-12 center-elements" *ngIf="submitted">
                <em class="fa fa-spinner fa-spin fa-2x fa-fw primary"></em>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #shareCustom let-c="close" let-d="dismiss" appendTo="body">
    <app-share-modal [shareTemplate]="contentshareCustom" [mode]="mode"
        (closeModal)="closeModalShare()"></app-share-modal>
</ng-template>

<ng-template #ContentOptionsMenu let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header" id="idHeader">
        <button type="button" class="close" aria-label="Close" (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body card mb-0">
        <div class="row">
            <div class="col-md-12 center-elements">
                <div class="col-md-12 mb-2 mt-3">
                    <p>{{'optionsMenu.t1' | translate }}</p>
                    <p>{{'optionsMenu.t2' | translate }} <em class="primary" style="cursor: pointer;"
                            placement="end-start" #p1="ngbPopover" [ngbPopover]="popContenthelp"
                            popoverTitle="{{'topnavbar.Help' | translate }}">{{'optionsMenu.t3' | translate }}</em>
                        {{'optionsMenu.t4' | translate }}</p>
                    <ng-template #popContenthelp>
                        <span [innerHTML]="welcomeMsg | safe: 'html'">
                        </span>
                        <button class="pull-right mt-2" style="margin-top: 1em;margin-bottom: 1em;"
                            (click)="p1.close()">{{'generics.Close' |translate }}</button>
                    </ng-template>
                </div>
                <div class="col-md-12 mb-2 mt-2 d-block" *ngIf="actualCategory == null">
                    <div class="border bg-grey bg-lighten-3 p-3">
                        <a class="mr-1" [ngClass]="(showOptionsData=='general')?'text-bold-700 border-custom':''"
                            (click)="changeOptionData('general')">{{'optionsMenu.t5' | translate }}</a>
                        <a class="ml-1 mr-1"
                            [ngClass]="(showOptionsData=='categoriesPatients')?'text-bold-700 border-custom':''"
                            (click)="changeOptionData('categoriesPatients')">{{'categoriesPatients.title' | translate
                            }}</a>
                        <a class="ml-1 mr-1"
                            [ngClass]="(showOptionsData=='categoriesCaregivers')?'text-bold-700 border-custom':''"
                            (click)="changeOptionData('categoriesCaregivers')">{{'categoriesCaregivers.title' |
                            translate }}</a>
                        <a class="ml-1"
                            [ngClass]="(showOptionsData == 'summaryTypes') ? 'text-bold-700 border-custom' : ''"
                            (click)="changeOptionData('summaryTypes')">{{'summaryoptions.title' | translate }}</a>
                    </div>
                </div>

                <!--<div class="col-md-12 mb-2 mt-2 d-block d-sm-none" *ngIf="actualCategory == null">
                <select (change)="changeOptionData($event.target.value)">
                    <option value="general">{{'optionsMenu.t5' | translate }}</option>
                    <option value="categoriesPatients">{{'categoriesPatients.title' | translate }}</option>
                    <option value="categoriesCaregivers">{{'categoriesCaregivers.title' | translate }}</option>
                </select>
            </div>-->
                <div *ngIf="showOptionsData=='general'" class="col-md-12">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                (click)="selectCustomSuggestion('optionsMenu.q1')">
                                {{'optionsMenu.q1' | translate }}
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                (click)="selectCustomSuggestion('optionsMenu.q2')">
                                {{'optionsMenu.q2' | translate }}
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                (click)="selectCustomSuggestion('optionsMenu.q3')">
                                {{'optionsMenu.q3' | translate }}
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                (click)="selectCustomSuggestion('optionsMenu.q4')">
                                {{'optionsMenu.q4' | translate }}
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="card card-body card-custom d-flex justify-content-center align-items-center">

                                <li class="d-inline-block" ngbDropdown display="dynamic" container="body">
                                    <a class="position-relative colorlink" id="dropdownLang" ngbDropdownToggle
                                        role="button">
                                        <u>{{'optionsMenu.q5' | translate }}</u>
                                    </a>
                                    <div ngbDropdownMenu aria-labelledby="dropdownLang" class="dropdownLang">
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.1')">
                                            <span>{{'optionsMenu.q5.1' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.2')">
                                            <span>{{'optionsMenu.q5.2' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.3')">
                                            <span>{{'optionsMenu.q5.3' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.4')">
                                            <span>{{'optionsMenu.q5.4' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.5')">
                                            <span>{{'optionsMenu.q5.5' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.6')">
                                            <span>{{'optionsMenu.q5.6' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.7')">
                                            <span>{{'optionsMenu.q5.7' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.8')">
                                            <span>{{'optionsMenu.q5.8' | translate }}</span>
                                        </a>
                                        <a class="dropdown-item py-1 lang" href="javascript:;"
                                            (click)="selectCustomSuggestion('optionsMenu.q5.9')">
                                            <span>{{'optionsMenu.q5.9' | translate }}</span>
                                        </a>
                                    </div>
                                </li>
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                (click)="selectCustomSuggestion('optionsMenu.q6')">
                                {{'optionsMenu.q6' | translate }}
                            </div>

                        </div>
                        <p class="text-muted small mt-2">
                            <em>{{'optionsMenu.hint' | translate }}</em>
                        </p>
                    </div>

                </div>
                <div *ngIf="showOptionsData == 'summaryTypes'" class="col-md-12">
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-6" *ngFor="let summaryType of summaryTypes">
                                <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                    (click)="selectSummaryType(summaryType.description)">
                                    <h5>{{summaryType.title | translate}}</h5>
                                    <p>{{summaryType.description | translate}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="showOptionsData!='general' && showOptionsData!='summaryTypes'" class="col-md-12">
                    <div *ngIf="actualCategory==null" class="row">
                        <p class="col-md-12 mb-0 mt-2 black text-bold-700">{{'generics.Select a category' | translate
                            }}:</p>
                        <span *ngIf="showOptionsData=='categoriesPatients'" class="col-md-12">
                            <div class="row">
                                <div *ngFor="let categorie of categoriesPatients" class="col-md-4">
                                    <div class="card card-body border card-categorie d-flex justify-content-center align-items-center pointer"
                                        (click)="selectCategorie(categorie)">
                                        <img class="logo-img-big" style="width: 60px;" [src]="categorie.icon" />
                                        <u>{{categorie.title}} </u>
                                    </div>
                                </div>
                            </div>
                        </span>
                        <span *ngIf="showOptionsData=='categoriesCaregivers'" class="col-md-12">
                            <div class="row">
                                <div *ngFor="let categorie of categoriesCaregivers" class="col-md-4">
                                    <div class="card card-body border card-categorie d-flex justify-content-center align-items-center pointer"
                                        (click)="selectCategorie(categorie)">
                                        <img class="logo-img-big" style="width: 60px;" [src]="categorie.icon" />
                                        <u>{{categorie.title}} </u>
                                    </div>
                                </div>
                            </div>
                        </span>
                    </div>
                    <div *ngIf="actualCategory != null" class="row">
                        <div class="col-md-12 center-elements">
                            <!-- Botón para regresar o seleccionar otra categoría -->
                            <button class="btn btn-dark" (click)="actualCategory = null"><em
                                    class="fa fa-arrow-up"></em> {{'generics.Back to categories' | translate }}</button>
                            <!-- Icono y nombre de la categoría seleccionada -->
                            <div class="category-header mt-4">
                                <img class="logo-img-small" style="width: 30px; height: 30px;"
                                    src="{{actualCategory.icon}}" />
                                <span class="text-bold-700">{{actualCategory.title}}</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="row">
                                <div *ngFor="let suggestion of actualCategory.questions" class="col-md-4">
                                    <div class="card card-body card-custom d-flex justify-content-center align-items-center pointer"
                                        (click)="selectSuggestion(suggestion)">
                                        {{suggestion}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
                <p class="mt-2" *ngIf="docs.length==0" [innerHTML]="'optionsMenu.t7' | translate"></p>
            </div>
        </div>

    </div>
</ng-template>
<ng-template #contentPhoto let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header" id="idHeader" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
        <div style="flex: 1;">
            <h5 class="modal-title mb-0" style="font-weight: 600; font-size: 1.1em;">
                {{'demo.Capture document' | translate }}
            </h5>
            <div *ngIf="stepPhoto==1" style="font-size: 0.85em; color: #666; margin-top: 4px; font-weight: 400;">
                {{'demo.Position the document in front of the camera' | translate }}
            </div>
            <div *ngIf="stepPhoto==2" style="font-size: 0.85em; color: #666; margin-top: 4px;">
                <span style="font-style: italic;">{{'demo.New document' | translate }} ({{'demo.unsaved' | translate }})</span>
                <span style="margin-left: 8px; font-weight: 500;">
                    {{'demo.Pages' | translate }}: 
                    <span *ngFor="let doc of tempDocs; let i = index">
                        <strong>{{i + 1}}</strong><span *ngIf="i < tempDocs.length - 1 || capturedImage"> · </span>
                    </span>
                    <strong *ngIf="capturedImage">{{tempDocs.length + 1}}</strong>
                </span>
            </div>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="closeModal();" style="margin-left: 15px;">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="row text-left">
            <div class="card-body col-md-12">
                <div class="row">
                    <div class="col-sm-12" *ngIf="stepPhoto==1">
                        <video #videoElement id="videoElement" class="w-100" autoplay></video>
                    </div>
                    <div class="col-sm-12" *ngIf="stepPhoto==2">
                        <div style="position: relative; display: inline-block; width: 100%;">
                            <img *ngIf="capturedImage" class="w-100" style="border: 1px solid #dee2e6; border-radius: 4px; display: block;" [src]="capturedImage" />
                            <button type="button" class="btn btn-outline-light" 
                                style="position: absolute; top: 10px; right: 10px; border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); background-color: rgba(255,255,255,0.9); border: 2px solid #fff;"
                                (click)="prevCamera();" 
                                title="{{'demo.Repeat page' | translate}}">
                                <i class="fa fa-redo" style="font-size: 1.2em; color: #333;"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div *ngIf="tempDocs.length>0" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <strong>{{'demo.Captured pages' | translate }}: {{tempDocs.length}}</strong>
            <p *ngFor="let doc of tempDocs; let i = index" class="mb-1 mt-2" style="font-size: 0.9em;">
                <span>{{i + 1}}. {{doc.dataFile.name}} <em class="ml-1 danger fa fa-trash pointer"
                        (click)="deletephoto(i)" title="{{'generics.Delete' | translate }}"></em></span>
            </p>
        </div>
    </div>
    <div class="modal-footer">
        <div class="form-actions col-md-12 center-elements">
            <button type="button" *ngIf="stepPhoto==1" class="btn btn-dark float-right"
                (click)="captureImage()">
                <i class="fa fa-camera mr-2"></i>{{'demo.Capture page' | translate }}
            </button>
            <button type="button" *ngIf="stepPhoto==2 && tempDocs.length<5" class="btn btn-dark float-left"
                (click)="otherPhoto(true)">
                <i class="fa fa-plus-circle mr-2"></i>{{'demo.Add another page' | translate }}
            </button>
            <button type="button" *ngIf="stepPhoto==2" class="btn btn-dark float-right"
                (click)="otherPhoto(false)">
                <i class="fa fa-check-circle mr-2"></i>{{'demo.Finalize document' | translate }}
            </button>
        </div>
    </div>
</ng-template>
<ng-template #contentviewSelectFile let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header modern-modal-header" id="idHeader">
        <div class="content-header text-left">
            <h4 class="mb-0 modern-modal-title">{{'demo.Add new document' | translate }}</h4>
        </div>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body modern-modal-body" id="idBody">
        <div class="add-document-options">
            <div class="row g-3">
                <div class="col-md-4" *ngIf="showCameraButton">
                    <div class="document-option-card" (click)="entryOpt('opt1', contentPhoto)">
                        <div class="option-icon-wrapper">
                            <i class="fa fa-camera option-icon"></i>
                        </div>
                        <h5 class="option-title">{{'demo.Take a photo' | translate }}</h5>
                        <p class="option-description">{{'demo.Take a photo description' | translate }}</p>
                    </div>
                </div>
                <div [ngClass]="{'col-md-4': showCameraButton, 'col-6': !showCameraButton}">
                    <div class="document-option-card upload-option">
                        <input *ngIf="!isMobile" type="file" #fileDropRef id="fileDropRef" multiple
                            style="display: none;" (change)="onFileChangeStep($event);"
                            accept=".pdf, .docx, .jpg, .png, .jpeg, .txt" />
                        <input *ngIf="isMobile" type="file" #fileDropRef id="fileDropRef" multiple
                            style="display: none;" (change)="onFileChangeStep($event);" />
                        <label for="fileDropRef" class="option-label">
                            <div class="option-icon-wrapper">
                                <i class="fa fa-upload option-icon"></i>
                            </div>
                            <h5 class="option-title">{{'generics.Upload' | translate }}</h5>
                            <p class="option-description">
                                <span class="d-block">{{'demo.Max. 5 documents' | translate }}</span>
                                <span class="d-block">{{'demo.You can upload more files later' | translate }}</span>
                            </p>
                        </label>
                    </div>
                </div>
                <div [ngClass]="{'col-md-4': showCameraButton, 'col-6': !showCameraButton}">
                    <div class="document-option-card" (click)="entryOpt('opt2', contentManual)">
                        <div class="option-icon-wrapper">
                            <i class="fa-solid fa-paste option-icon"></i>
                        </div>
                        <h5 class="option-title">{{'demo.Write text' | translate }}</h5>
                        <p class="option-description">{{'demo.Write text description' | translate }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>
<ng-template #contentManual id="contentManual" let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header modern-modal-header" id="idHeader">
        <div class="content-header text-left">
            <h4 class="mb-0 modern-modal-title">{{'demo.Create report' | translate }}</h4>
        </div>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="closeModal();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body modern-modal-body create-report-modal" id="idBody">
        <div class="create-report-form">
            <!--<div class="voice-recorder" *ngIf="supported" style="margin-bottom: 20px;">
                <div class="card-body border round p-3 mic-icon pointer bg-white" (click)="toggleRecording()">
                  <span *ngIf="!recording" class="d-block">{{'voice.Start Voice Recognition' | translate }}</span>
                  <i class="mt-2 fa-2x fa fa-microphone" *ngIf="!recording"></i>
                  <span *ngIf="recording" class="d-block">{{'voice.Stop Voice Recognition' | translate }}</span>
                  <i class="mt-2 fa-2x fa fa-stop danger" *ngIf="recording"></i>
                  <div *ngIf="recording" class="d-block recording-indicator">
                    <i class="fa fa-circle record-icon"></i> {{'voice.Recording' | translate }}...
                  </div>
                  <div *ngIf="recording" class="d-block">
                    <p>{{ timerDisplay }}</p>
                  </div>
                </div>
                
              </div>-->
            
            <div class="form-group">
                <label class="form-label">{{'voice.Enter file name' | translate }}</label>
                <div class="input-with-button">
                    <input type="text" class="form-control modern-input" [(ngModel)]="tempFileName"
                        placeholder="{{'voice.Enter file name' | translate }}" />
                    <button *ngIf="supported" class="btn btn-icon-only" 
                        (click)="toggleRecording()" 
                        [ngClass]="{'btn-recording': recording, 'btn-primary': !recording}"
                        [title]="recording ? ('voice.Stop Voice Recognition' | translate) : ('voice.Start Voice Recognition' | translate)">
                        <i class="fa" [ngClass]="recording ? 'fa-stop' : 'fa-microphone'"></i>
                        <span *ngIf="recording" class="recording-timer">{{ timerDisplay }}</span>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">{{'generics.Write or paste content' | translate }}</label>
                <div class="textarea-with-button">
                    <textarea #inputTextArea class="form-control modern-textarea data-hj-allow" 
                        [(ngModel)]="medicalText" name="medicalText"
                        placeholder="{{'generics.Write or paste content' | translate }}"></textarea>
                    <button *ngIf="supported" class="btn btn-icon-only btn-voice-textarea" 
                        (click)="toggleRecording()" 
                        [ngClass]="{'btn-recording': recording, 'btn-primary': !recording}"
                        [title]="recording ? ('voice.Stop Voice Recognition' | translate) : ('voice.Start Voice Recognition' | translate)">
                        <i class="fa" [ngClass]="recording ? 'fa-stop' : 'fa-microphone'"></i>
                        <span *ngIf="recording" class="recording-timer">{{ timerDisplay }}</span>
                    </button>
                </div>
                <small *ngIf="!supported" class="voice-not-supported-message">
                    <i class="fa fa-info-circle mr-1"></i>
                    {{'voice.Not supported in this browser' | translate}}
                </small>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-save"
                    [disabled]="callingSummary || recording || medicalText.length==0"
                    [title]="'generics.Save' | translate" 
                    (click)="createFile();">
                    <i class="fa fa-save mr-2"></i>
                    <span>{{'generics.Save' | translate }}</span>
                </button>
            </div>
        </div>
    </div>
</ng-template>
<ng-template #PanelChangeDate let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header" id="idHeader">
        <div class="content-header text-left">
            <h4 class="mb-0">{{'dashboardpatient.Update document date' | translate }}</h4>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="closeModal2();">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body content-wrapper p-2" id="idBody">
        <div class="p-1">
            <div class="form-body">
                <div class="center-elements pb-2 col-12" href="javascript:void(0)">
                    <mat-form-field appearance="fill">
                        <mat-label>{{'generics.Date' | translate }}</mat-label>
                        <input matInput [matDatepicker]="picker" readonly [(ngModel)]="tempDoc.originaldate"
                            (click)="picker.open()">
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker touchUi="true" #picker></mat-datepicker>
                    </mat-form-field>

                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <div class="form-actions col-md-12 center-elements">
            <button type="button" class="btn btn-secondary mr-1" (click)="closeModal2();">{{'generics.Cancel' |
                translate }}</button>
            <button type="button" class="btn btn-dark ml-1" (click)="updateDocDate();">{{'dashboardpatient.confirm' |
                translate }}</button>
        </div>
    </div>
</ng-template>
<ng-template #addNoteModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'notes.Add Note' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="cancelEdit()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="note-editor-container mb-2">
            <quill-editor 
                [modules]="quillConfig"
                [ngModel]="newNoteContent"
                (ngModelChange)="onNewNoteContentChange($event)"
                (onEditorCreated)="onNewNoteEditorCreated($event)"
                [styles]="quillEditorStyles"
                [placeholder]="'notes.Enter note content' | translate">
            </quill-editor>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">{{'generics.Cancel' |
            translate}}</button>
        <button type="button" class="btn btn-primary" (click)="saveNote()" [disabled]="savingNote">
            <em class="fa fa-check"></em> {{'generics.Save' | translate}}
        </button>
    </div>
</ng-template>

<ng-template #noteFullModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'notes.Note' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="closeNoteModal()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div *ngIf="selectedNoteForModal">
            <div [innerHTML]="selectedNoteForModal.content | safe: 'html'" class="note-full-content"></div>
            <small class="text-muted d-block mt-2">{{selectedNoteForModal.date | date: 'longDate'}}</small>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeNoteModal()">{{'generics.Close' | translate }}</button>
    </div>
</ng-template>

<ng-template #editNoteModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'notes.Edit Note' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="cancelNoteEdit()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div *ngIf="editingNoteIndex !== null && editingNoteIndex !== undefined && notes[editingNoteIndex]">
            <div class="note-editor-container mb-2">
                <quill-editor 
                    [modules]="quillConfig"
                    [ngModel]="notes[editingNoteIndex].editContent"
                    (ngModelChange)="onNoteContentChange($event)"
                    (onEditorCreated)="onEditorCreated($event)"
                    [styles]="quillEditorStyles"
                    [placeholder]="'notes.Enter note content' | translate">
                </quill-editor>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelNoteEdit()">{{'generics.Cancel' | translate }}</button>
        <button type="button" class="btn btn-primary" (click)="saveNoteEdit()" [disabled]="savingNote">
            <em class="fa fa-check"></em> {{'generics.Save' | translate }}
        </button>
    </div>
</ng-template>

<!-- Modal de DxGPT -->
<ng-template #dxGptModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'dxgpt.button' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body dxgpt-modal-body">
        <div class="dxgpt-content p-4">
            <div class="text-center">
                <img src="assets/img/logo-dxgpt.png" alt="DxGPT Logo" class="mt-6" style="width: 170px; height: 62px; object-fit: contain;" loading="eager" fetchpriority="high">

                <!-- Loading state -->
                <div *ngIf="isDxGptLoading" class="my-2">
                    <div class="spinner-border text-primary mt-3" role="status">
                        <span class="sr-only">{{ 'generics.Loading' | translate }}...</span>
                    </div>
                    <p class="mt-3 text-muted">{{ 'dxgpt.analyzing' | translate }}</p>
                </div>

                <!-- Button to fetch results (Initial state) -->
                <div *ngIf="!isDxGptLoading && !dxGptResults" class="my-2">
                    <p class="mt-3 mb-4" style="max-width: 600px; margin: 0 auto; text-align: center; font-size: 1.05rem; padding: 0 1rem;">{{ 'dxgpt.description' | translate }}</p>
                    <button 
                        type="button"
                        class="btn btn-dark btn-lg" 
                        (click)="fetchDxGptResults()" 
                        [disabled]="!currentPatientId">
                        <i class="fa fa-stethoscope mr-2"></i>
                        {{ 'dxgpt.analyze' | translate }}
                    </button>
                    <p *ngIf="!currentPatientId" class="text-danger mt-2">
                        {{ 'patients.No patient selected' | translate }}
                    </p>
                </div>

                <!-- Results with existing styles -->
                <div *ngIf="!isDxGptLoading && dxGptResults && dxGptResults.success && dxGptResults.analysis" 
                     class="dxgpt-results text-left">
                    
                    <!-- Anonymized patient info -->
                    <div class="patient-info-card mb-4 mt-4" *ngIf="dxGptResults.analysis.anonymization">
                        <div class="patient-info-header">
                            <i class="fa fa-user-shield"></i>
                            <h5>{{ 'dxgpt.patientInfo' | translate }}</h5>
                            <button class="btn btn-sm btn-link edit-patient-info-btn" 
                                    *ngIf="!isEditingPatientInfo"
                                    (click)="startEditingPatientInfo()">
                                <i class="fa fa-pencil"></i>
                            </button>
                        </div>
                        <div class="patient-info-text" *ngIf="!isEditingPatientInfo">
                          <div class="patient-info-content" 
                               [class.collapsed]="!isPatientInfoExpanded"
                               [class.expanded]="isPatientInfoExpanded">
                            <div *ngIf="dxGptResults.analysis.anonymization.anonymizedTextHtml" 
                                 [innerHTML]="dxGptResults.analysis.anonymization.anonymizedTextHtml | safe: 'html'"></div>
                            <div *ngIf="!dxGptResults.analysis.anonymization.anonymizedTextHtml" 
                                 [style.white-space]="'pre-line'">{{ dxGptResults.analysis.anonymization.anonymizedText }}</div>
                          </div>
                          <button class="btn btn-sm btn-link patient-info-toggle" 
                                  *ngIf="shouldShowPatientInfoToggle()"
                                  (click)="togglePatientInfo()">
                            <i class="fa" [ngClass]="isPatientInfoExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                            {{ isPatientInfoExpanded ? ('generics.Read less' | translate) : ('generics.Read more' | translate) }}
                          </button>
                        </div>
                        
                        <!-- Edit mode -->
                        <div *ngIf="isEditingPatientInfo" class="patient-info-edit">
                            <textarea 
                                class="form-control patient-info-textarea"
                                [(ngModel)]="editedPatientInfo"
                                rows="5"
                                placeholder="{{ 'dxgpt.enterPatientDescription' | translate }}">
                            </textarea>
                            <div class="mt-2 text-right">
                                <button class="btn btn-sm btn-secondary mr-2" (click)="cancelEditingPatientInfo()">
                                    {{ 'generics.Cancel' | translate }}
                                </button>
                                <button class="btn btn-sm btn-danger" (click)="saveEditedPatientInfo()">
                                    <i class="fa fa-save mr-1"></i>
                                    {{ 'generics.Save' | translate }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Informative message about editing patient info -->
                    <div class="alert alert-info mt-3 mb-4" role="alert" style="max-width: 100%;">
                        <i class="fa fa-info-circle mr-2"></i>
                        <strong>{{ 'dxgpt.editInfo.title' | translate }}</strong>
                        <p class="mb-0 mt-2">{{ 'dxgpt.editInfo.message' | translate }}</p>
                    </div>

                    <!-- Diagnoses title and cards container -->
                    <div class="diagnosis-cards-container">
                        <h4 class="mb-4 text-left">{{ 'dxgpt.possibleDiagnoses' | translate }}</h4>
                        <div *ngFor="let diagnosis of dxGptResults.analysis.data; let i = index" 
                             class="mb-3">
                            <div class="card diagnosis-card">
                                <div class="card-body">
                                    <!-- Diagnosis header -->
                                    <div class="mb-3">
                                        <!-- Primera fila: número + título + learn more -->
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="d-flex align-items-center">
                                                <span class="badge badge-danger mr-2" style="min-width: 2rem;">
                                                    {{ i + 1 }}
                                                </span>
                                                <h5 class="diagnosis-name mb-0">
                                                    {{ diagnosis.diagnosis }}
                                                </h5>
                                            </div>
                                            <a href="javascript:void(0)" class="text-danger" style="font-size: 0.95rem; text-decoration: none;" (click)="toggleDiagnosisCard(i)">
                                                {{ 'dxgpt.moreInfo' | translate }}
                                            </a>
                                        </div>
                                        
                                        <!-- Segunda fila: descripción -->
                                        <p class="card-text text-dark mb-3">
                                            {{ diagnosis.description }}
                                        </p>
                                    </div>
                                    
                                    <!-- Symptoms section -->
                                    <div class="symptoms-section">
                                        <div class="symptoms-columns">
                                            <!-- Matching symptoms column -->
                                            <div class="symptoms-column">
                                                <h6 class="mb-3">{{ 'dxgpt.matchingSymptoms' | translate }}</h6>
                                                <div *ngIf="diagnosis.symptoms_in_common && diagnosis.symptoms_in_common.length > 0">
                                                    <div *ngFor="let symptom of diagnosis.symptoms_in_common" class="symptom-item">
                                                        <span class="symptom-icon symptom-icon-match"></span>
                                                        <span>{{ symptom }}</span>
                                                    </div>
                                                </div>
                                                <div *ngIf="!diagnosis.symptoms_in_common || diagnosis.symptoms_in_common.length === 0" class="text-muted">
                                                    <small>{{ 'dxgpt.noMatchingSymptoms' | translate }}</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Additional symptoms column -->
                                            <div class="symptoms-column">
                                                <h6 class="mb-3">{{ 'dxgpt.additionalSymptoms' | translate }}</h6>
                                                <div *ngIf="diagnosis.symptoms_not_in_common && diagnosis.symptoms_not_in_common.length > 0">
                                                    <div *ngFor="let symptom of diagnosis.symptoms_not_in_common" class="symptom-item">
                                                        <span class="symptom-icon symptom-icon-additional"></span>
                                                        <span>{{ symptom }}</span>
                                                    </div>
                                                </div>
                                                <div *ngIf="!diagnosis.symptoms_not_in_common || diagnosis.symptoms_not_in_common.length === 0" class="text-muted">
                                                    <small>{{ 'dxgpt.noAdditionalSymptoms' | translate }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Nueva card expandible con secciones de preguntas -->
                            <div class="card diagnosis-card mt-3" *ngIf="isDiagnosisCardExpanded(i)" [@slideDown]>
                                <div class="card-body p-0">
                                    <!-- Sección 1: Síntomas comunes -->
                                    <div class="diagnosis-question-section">
                                        <div class="diagnosis-question-row" 
                                             [class.active]="isQuestionExpanded(i, 0)"
                                             [class.visited]="isQuestionVisited(i, 0)"
                                             (click)="toggleQuestion(i, 0)">
                                            <p class="diagnosis-question mb-0">{{'dxgpt.commonSymptoms' | translate}}</p>
                                        </div>
                                        <div class="diagnosis-answer" *ngIf="isQuestionExpanded(i, 0)" [@slideDown]>
                                            <div *ngIf="isQuestionLoading(i, 0)" class="text-center">
                                                <i class="fa fa-spinner fa-pulse"></i> {{'generics.Loading' | translate}}...
                                            </div>
                                            <div *ngIf="!isQuestionLoading(i, 0)" [innerHTML]="getQuestionResponse(i, 0)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sección 2: Información detallada -->
                                    <div class="diagnosis-question-section">
                                        <div class="diagnosis-question-row"
                                             [class.active]="isQuestionExpanded(i, 1)"
                                             [class.visited]="isQuestionVisited(i, 1)"
                                             (click)="toggleQuestion(i, 1)">
                                            <p class="diagnosis-question mb-0">{{'dxgpt.detailedInformation' | translate}}</p>
                                        </div>
                                        <div class="diagnosis-answer" *ngIf="isQuestionExpanded(i, 1)" [@slideDown]>
                                            <div *ngIf="isQuestionLoading(i, 1)" class="text-center">
                                                <i class="fa fa-spinner fa-pulse"></i> {{'generics.Loading' | translate}}...
                                            </div>
                                            <div *ngIf="!isQuestionLoading(i, 1)" [innerHTML]="getQuestionResponse(i, 1)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sección 3: Pruebas diagnósticas -->
                                    <div class="diagnosis-question-section">
                                        <div class="diagnosis-question-row"
                                             [class.active]="isQuestionExpanded(i, 2)"
                                             [class.visited]="isQuestionVisited(i, 2)"
                                             (click)="toggleQuestion(i, 2)">
                                            <p class="diagnosis-question mb-0">{{'dxgpt.diagnosticTests' | translate}}</p>
                                        </div>
                                        <div class="diagnosis-answer" *ngIf="isQuestionExpanded(i, 2)" [@slideDown]>
                                            <div *ngIf="isQuestionLoading(i, 2)" class="text-center">
                                                <i class="fa fa-spinner fa-pulse"></i> {{'generics.Loading' | translate}}...
                                            </div>
                                            <div *ngIf="!isQuestionLoading(i, 2)" [innerHTML]="getQuestionResponse(i, 2)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sección 4: Síntomas diferenciales -->
                                    <div class="diagnosis-question-section">
                                        <div class="diagnosis-question-row"
                                             [class.active]="isQuestionExpanded(i, 3)"
                                             [class.visited]="isQuestionVisited(i, 3)"
                                             (click)="toggleQuestion(i, 3)">
                                            <p class="diagnosis-question mb-0">{{'dxgpt.differentialSymptoms' | translate}}</p>
                                        </div>
                                        <div class="diagnosis-answer" *ngIf="isQuestionExpanded(i, 3)" [@slideDown]>
                                            <div *ngIf="isQuestionLoading(i, 3)" class="text-center">
                                                <i class="fa fa-spinner fa-pulse"></i> {{'generics.Loading' | translate}}...
                                            </div>
                                            <div *ngIf="!isQuestionLoading(i, 3)">
                                                <!-- Custom symptom list with checkboxes -->
                                                <div *ngIf="getQuestionResponse(i, 3) === 'custom-symptom-list'">
                                                    <div *ngFor="let symptom of getSymptoms(i, 3); let j = index" class="custom-control custom-checkbox mb-2">
                                                        <input type="checkbox" 
                                                               class="custom-control-input" 
                                                               [id]="'symptom-' + i + '-' + j"
                                                               [(ngModel)]="symptom.checked">
                                                        <label class="custom-control-label" [for]="'symptom-' + i + '-' + j">
                                                            {{ symptom.name }}
                                                        </label>
                                                    </div>
                                                    <button class="btn btn-danger btn-sm mt-3" (click)="reRunDiagnosis(i, 3)">
                                                        <i class="fa fa-redo mr-1"></i>
                                                        {{'dxgpt.reanalyzeWithSymptoms' | translate}}
                                                    </button>
                                                </div>
                                                <!-- Normal HTML content -->
                                                <div *ngIf="getQuestionResponse(i, 3) !== 'custom-symptom-list'" 
                                                     [innerHTML]="getQuestionResponse(i, 3)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sección 5: Coincidencias de síntomas -->
                                    <div class="diagnosis-question-section">
                                        <div class="diagnosis-question-row"
                                             [class.active]="isQuestionExpanded(i, 4)"
                                             [class.visited]="isQuestionVisited(i, 4)"
                                             (click)="toggleQuestion(i, 4)">
                                            <p class="diagnosis-question mb-0">{{'dxgpt.symptomMatches' | translate}}</p>
                                        </div>
                                        <div class="diagnosis-answer" *ngIf="isQuestionExpanded(i, 4)" [@slideDown]>
                                            <div *ngIf="isQuestionLoading(i, 4)" class="text-center">
                                                <i class="fa fa-spinner fa-pulse"></i> {{'generics.Loading' | translate}}...
                                            </div>
                                            <div *ngIf="!isQuestionLoading(i, 4)" [innerHTML]="getQuestionResponse(i, 4)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Button to find more diagnoses -->
                        <div class="text-center mt-4" *ngIf="!isSearchingMoreDiagnoses">
                            <button class="btn btn-outline-danger" (click)="findMoreDiagnoses()">
                                {{ 'dxgpt.findMoreDiagnoses' | translate }}
                            </button>
                        </div>
                        <div class="text-center mt-4" *ngIf="isSearchingMoreDiagnoses">
                            <p class="mt-2 text-muted">{{ 'dxgpt.searchingMoreDiagnoses' | translate }}</p>
                        </div>
                    </div>
                </div>

                <!-- Error state -->
                <div *ngIf="!isDxGptLoading && dxGptResults && !dxGptResults.success" class="alert alert-danger mt-4">
                    {{ dxGptResults.error || ('dxgpt.errorMessage' | translate) }}
                </div>

                <!-- Retry button -->
                <div *ngIf="!isDxGptLoading && dxGptResults && !dxGptResults.success" class="text-center mt-3">
                    <button class="btn btn-danger" (click)="fetchDxGptResults()">
                        {{ 'dxgpt.tryAgain' | translate }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Close click')">{{'generics.Close' | translate}}</button>
    </div>
</ng-template>

<!-- Modal de Notas -->
<ng-template #notesModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'notes.title' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body notes-modal-body">
        <div class="notes-modal-content">
            <div class="sidebar-header center-elements mb-3">
                <button type="button" class="btn btn-dark" (click)="addNote(addNoteModal)"
                    title="{{'notes.Add Note' | translate}}">
                    <i class="white fa fa-plus mr-1"></i> {{'notes.Add Note' | translate}}
                </button>                   
            </div>
            <div *ngIf="notes.length > 0" class="pb-3">
                <ul class="notes-list">
                    <li *ngFor="let note of notes; let i = index" class="mt-3 card bg-grey bg-lighten-4">
                        <div class="note-content">
                            <!-- Modo visualización -->
                            <div *ngIf="!note.isEditing">
                                <div *ngIf="truncateNoteContent(note.content, noteMaxLength).isTruncated; else fullContent">
                                    <p [innerHTML]="truncateNoteContent(note.content, noteMaxLength).truncated | safe: 'html'"></p>
                                    <button (click)="viewFullNote(note, noteFullModal)" class="btn btn-sm btn-link p-0 mt-1">
                                        {{'notes.View more' | translate}}
                                    </button>
                                </div>
                                <ng-template #fullContent>
                                    <p [innerHTML]="note.content | safe: 'html'"></p>
                                </ng-template>
                                <small>{{note.date | date: 'longDate'}}</small>
                                <div class="mt-2">
                                    <div class="btn-group" role="group">
                                        <button (click)="deleteNote(i)" class="btn btn-sm btn-danger" [disabled]="deletingNote" title="{{'generics.Delete' | translate }}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                        <button (click)="copymsg(note.content)" class="btn btn-sm btn-white custom-white-button" title="{{'generics.Copy' | translate }}">
                                            <i class="fa fa-copy"></i>
                                        </button>
                                        <button (click)="editNote(i, editNoteModal)" class="btn btn-sm btn-white custom-white-button" title="{{'generics.Edit' | translate }}">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div *ngIf="notes.length === 0">
                <div class="center-elements pt-3">
                    <p>{{'notes.noNotes' | translate}}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Close click')">{{'generics.Close' | translate}}</button>
    </div>
</ng-template>

<!-- Modal de Rarescope (Mis Necesidades) -->
<ng-template #rarescopeModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'rarescope.My Needs' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body rarescope-modal-body">
        <div class="rarescope-content p-4">
            <div class="rarescope-intro mb-3 mt-3 text-center">
                <p>{{'rarescope.rarescopeAnalysis' | translate}}</p>
                <button *ngIf="!isLoadingRarescope && !rarescopeError" 
                        class="btn btn-sm btn-outline-secondary mt-2" 
                        (click)="fetchRarescopeAnalysis()"
                        title="Actualizar análisis con la información más reciente">
                    <i class="fa fa-refresh mr-1"></i> {{'rarescope.updateAnalysis' | translate}}
                </button>
            </div>
            
            <!-- Loading state -->
            <div *ngIf="isLoadingRarescope" class="text-center p-5">
                <em class="fa fa-spinner fa-spin fa-3x fa-fw text-muted"></em>
                <p class="mt-3 text-muted">{{'rarescope.analyzingInformation' | translate}}...</p>
            </div>
            
            <!-- Error state -->
            <div *ngIf="rarescopeError && !isLoadingRarescope" class="alert alert-danger mx-auto" style="max-width: 600px;">
                <i class="fa fa-exclamation-triangle mr-2"></i>
                {{ rarescopeError }}
                <button class="btn btn-sm btn-danger ml-3" (click)="fetchRarescopeAnalysis()">
                    <i class="fa fa-refresh mr-1"></i> {{'rarescope.tryAgain' | translate}}
                </button>
            </div>
            
            <div *ngIf="!isLoadingRarescope && !rarescopeError" class="rarescope-needs-container" cdkDropList (cdkDropListDropped)="onDropNeed($event)">
                <div class="need-wrapper">
                    <div class="need-number-external">1</div>
                    <div class="need-section-wrapper mb-2" cdkDrag [cdkDragDisabled]="false"
                         [@slideOut]="deletingStates[0] ? 'out' : 'in'">
                        <div class="need-section">
                            <div class="controls-container-left">
                                <div class="drag-handle" cdkDragHandle [title]="'rarescope.dragToReorder' | translate">
                                    <i class="fa fa-grip-vertical"></i>
                                </div>
                            </div>
                        <div class="need-content"
                             contenteditable="true" 
                             [attr.data-placeholder]="'rarescope.placeholderNeed' | translate"
                             spellcheck="false"
                             [innerText]="rarescopeNeeds[0]"
                             (blur)="onNeedBlur($event, 0)">
                        </div>
                        <div class="controls-container-right">
                            <button class="delete-handle" (click)="deleteNeed(0)" title="Eliminar">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview personalizado para el drag -->
                    <div *cdkDragPreview class="custom-drag-preview">
                        <div class="need-section">
                            <div class="need-content">{{ rarescopeNeeds[0] }}</div>
                        </div>
                    </div>
                </div>
                </div>
                
                <div *ngFor="let need of additionalNeeds; let i = index; trackBy: trackByIndex" class="need-wrapper">
                    <div class="need-number-external">{{ i + 2 }}</div>
                    <div class="need-section-wrapper mb-2" cdkDrag [cdkDragDisabled]="false"
                         [@slideOut]="deletingStates[i + 1] ? 'out' : 'in'">
                        <div class="need-section">
                            <div class="controls-container-left">
                                <div class="drag-handle" cdkDragHandle [title]="'rarescope.dragToReorder' | translate">
                                    <i class="fa fa-grip-vertical"></i>
                                </div>
                            </div>
                        <div class="need-content"
                             contenteditable="true"
                             [attr.data-placeholder]="'rarescope.placeholderNeed' | translate"
                             spellcheck="false"
                             [innerText]="additionalNeeds[i]"
                             (blur)="onNeedBlur($event, i + 1)">
                        </div>
                        <div class="controls-container-right">
                            <button class="delete-handle" (click)="deleteNeed(i + 1)" title="Eliminar">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview personalizado para el drag -->
                    <div *cdkDragPreview class="custom-drag-preview">
                        <div class="need-section">
                            <div class="need-content">{{ need }}</div>
                        </div>
                    </div>
                </div>
                </div>
                
                <div class="add-section-btn" (click)="addNewNeed()">
                    <i class="fa fa-plus"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Close click')">{{'generics.Close' | translate}}</button>
    </div>
</ng-template>

<!-- Modal de Preparar Consulta -->
<ng-template #prepareConsultModal let-modal>
    <div class="modal-header prepare-consult-header">
        <div class="d-flex align-items-center">
            <i class="fa fa-calendar-check-o mr-2" style="font-size: 1.5rem; color: #7c4dff;"></i>
            <h4 class="modal-title mb-0">{{'prepareConsult.title' | translate}}</h4>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body prepare-consult-body">
        <div class="prepare-consult-content">
            <p class="prepare-consult-description text-center mb-4">
                {{'prepareConsult.description' | translate}}
            </p>
            
            <!-- Campo: Especialista -->
            <div class="prepare-consult-field mb-3">
                <label class="prepare-consult-label">
                    <i class="fa fa-user-md mr-2"></i>
                    {{'prepareConsult.specialist' | translate}}
                </label>
                <div class="prepare-consult-input-wrapper" 
                     [class.editing]="prepareConsultEditMode.specialist">
                    <input type="text" 
                           class="prepare-consult-input"
                           [(ngModel)]="prepareConsultData.specialist"
                           [placeholder]="'prepareConsult.specialistPlaceholder' | translate"
                           [readonly]="!prepareConsultEditMode.specialist"
                           (focus)="prepareConsultEditMode.specialist = true"
                           (blur)="prepareConsultEditMode.specialist = false">
                    <button class="prepare-consult-edit-btn" 
                            (click)="togglePrepareConsultEdit('specialist')"
                            [title]="'prepareConsult.editTooltip' | translate">
                        <i class="fa" [ngClass]="prepareConsultEditMode.specialist ? 'fa-check' : 'fa-pencil'"></i>
                    </button>
                </div>
            </div>
            
            <!-- Campo: Fecha de la consulta -->
            <div class="prepare-consult-field mb-3">
                <label class="prepare-consult-label">
                    <i class="fa fa-calendar mr-2"></i>
                    {{'prepareConsult.consultDate' | translate}}
                </label>
                <div class="prepare-consult-input-wrapper"
                     [class.editing]="prepareConsultEditMode.consultDate">
                    <input type="text" 
                           class="prepare-consult-input"
                           [(ngModel)]="prepareConsultData.consultDate"
                           [placeholder]="'prepareConsult.consultDatePlaceholder' | translate"
                           [readonly]="!prepareConsultEditMode.consultDate"
                           (focus)="prepareConsultEditMode.consultDate = true"
                           (blur)="prepareConsultEditMode.consultDate = false">
                    <button class="prepare-consult-edit-btn"
                            (click)="togglePrepareConsultEdit('consultDate')"
                            [title]="'prepareConsult.editTooltip' | translate">
                        <i class="fa" [ngClass]="prepareConsultEditMode.consultDate ? 'fa-check' : 'fa-pencil'"></i>
                    </button>
                </div>
            </div>
            
            <!-- Campo: Comentarios / Qué preparar -->
            <div class="prepare-consult-field mb-4">
                <label class="prepare-consult-label">
                    <i class="fa fa-comment-o mr-2"></i>
                    {{'prepareConsult.comments' | translate}}
                </label>
                <div class="prepare-consult-textarea-wrapper"
                     [class.editing]="prepareConsultEditMode.comments">
                    <textarea class="prepare-consult-textarea"
                              [(ngModel)]="prepareConsultData.comments"
                              [placeholder]="'prepareConsult.commentsPlaceholder' | translate"
                              [readonly]="!prepareConsultEditMode.comments"
                              (focus)="prepareConsultEditMode.comments = true"
                              (blur)="prepareConsultEditMode.comments = false"
                              rows="4"></textarea>
                    <button class="prepare-consult-edit-btn textarea-edit-btn"
                            (click)="togglePrepareConsultEdit('comments')"
                            [title]="'prepareConsult.editTooltip' | translate">
                        <i class="fa" [ngClass]="prepareConsultEditMode.comments ? 'fa-check' : 'fa-pencil'"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer prepare-consult-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss('Close click')">
            {{'generics.Cancel' | translate}}
        </button>
        <button type="button" 
                class="btn btn-primary prepare-consult-generate-btn"
                (click)="sendPreparedConsult()"
                [disabled]="!prepareConsultData.specialist && !prepareConsultData.comments">
            <i class="fa fa-magic mr-2"></i>
            {{'prepareConsult.generate' | translate}}
        </button>
    </div>
</ng-template>

<!-- Modal de Diario -->
<ng-template #diaryModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">{{'diary.title' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body diary-modal-body">
        <app-diary class="diary-in-modal"></app-diary>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Close click')">{{'generics.Close' | translate}}</button>
    </div>
</ng-template>
<ng-template #documentContextModal let-c="close" let-d="dismiss" appendTo="body">
    <div class="modal-header premium-modal-header border-0">
        <div class="w-100">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="mb-1 premium-modal-title">{{'generics.Manage documents' | translate }}</h5>
                    <p class="mb-0 premium-modal-subtitle">{{'generics.Documents context explanation' | translate }}</p>
                </div>
                <button type="button" class="close premium-close-btn" aria-label="Close" (click)="closeDocumentContextModal();">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
    <div class="modal-body premium-modal-body" style="max-height: 65vh; overflow-y: auto;">
        <div class="premium-action-bar mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <span class="premium-section-label">{{'generics.Select documents to include' | translate }}</span>
                <div class="premium-action-buttons">
                    <button type="button" class="btn-premium-link" (click)="selectAllContextDocuments()">
                        {{'generics.Select all' | translate }}
                    </button>
                    <span class="premium-divider">|</span>
                    <button type="button" class="btn-premium-link" (click)="deselectAllContextDocuments()">
                        {{'generics.Deselect all' | translate }}
                    </button>
                </div>
            </div>
        </div>
        
        <div class="premium-documents-list">
            <div *ngFor="let doc of availableContextDocs" 
                 class="premium-document-item"
                 [class.premium-selected]="doc.selected"
                 [class.premium-unselected]="!doc.selected">
                <div class="premium-document-checkbox-wrapper">
                    <input type="checkbox" 
                           [(ngModel)]="doc.selected" 
                           class="premium-checkbox"
                           [id]="'doc-' + doc._id">
                    <label [for]="'doc-' + doc._id" class="premium-checkbox-label"></label>
                </div>
                <div class="premium-document-content">
                    <div class="premium-document-header">
                        <div class="premium-document-title-wrapper">
                            <span class="premium-file-icon" [style.color]="getFileIconColor(doc.title)">
                                <em [class]="'fa ' + getFileIconClass(doc.title)"></em>
                            </span>
                            <span class="premium-document-title">{{doc.title}}</span>
                        </div>
                        <button type="button" 
                                class="premium-delete-btn" 
                                (click)="deleteDocumentFromModal(doc)"
                                [title]="'generics.Delete' | translate"
                                *ngIf="doc.isOwner">
                            <em class="fa fa-trash-o"></em>
                        </button>
                    </div>
                    <div class="premium-document-meta">
                        <span class="premium-meta-item" *ngIf="!isDateMissing(doc.originaldate)">
                            <em class="fa fa-calendar"></em>
                            <span>{{ doc.originaldate | date: 'mediumDate' }}</span>
                        </span>
                        <span class="premium-meta-item premium-warning" *ngIf="isDateMissing(doc.originaldate)">
                            <em class="fa fa-exclamation-triangle"></em>
                            <span>{{ 'generics.Missing date' | translate }}</span>
                        </span>
                        <span class="premium-category-badge" *ngIf="doc.categoryTag" [ngClass]="doc.badge">
                            {{doc.categoryTag}}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div *ngIf="availableContextDocs.length === 0" class="premium-empty-state">
            <div class="premium-empty-icon">
                <em class="fa fa-folder-open"></em>
            </div>
            <p class="premium-empty-text">{{'generics.No documents available' | translate }}</p>
        </div>
    </div>
    <div class="modal-footer premium-modal-footer border-0">
        <div class="w-100 d-flex justify-content-end">
            <button type="button" class="btn-premium-secondary" (click)="closeDocumentContextModal();">
                {{'generics.Cancel' | translate }}
            </button>
            <button type="button" class="btn-premium-primary" (click)="saveDocumentContextSelection();">
                {{'generics.Save' | translate }}
            </button>
        </div>
    </div>
</ng-template>